
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>ibmcloudsql.cos &#8212; SQLClient alpha documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/custom.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">SQLClient</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../includeme.html">README</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">ibmcloudsql.utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cos.html">ibmcloudsql.cos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql_magic.html">ibmcloudsql.sql_magic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql_query.html">ibmcloudsql.SQLQuery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">ibmcloudsql</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ibmcloudsql.cos</h1><div class="highlight"><pre>
<span></span><span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Copyright IBM Corp. 2020</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="kn">import</span> <span class="nn">ibmcloudsql</span>
<span class="kn">import</span> <span class="nn">ibm_boto3</span>
<span class="kn">from</span> <span class="nn">ibm_botocore.client</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">exceptions</span> <span class="kn">import</span> <span class="n">RateLimitedException</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">RateLimitedException</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">IBMCloudAccess</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">IBMCloudAccess</span>
<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">HTTPError</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Represents an IBM Watson Studio project</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="Project"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.Project">[docs]</a><span class="k">class</span> <span class="nc">Project</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;https://api.dataplatform.cloud.ibm.com/api-explorer/#/Projects/getProjects</span>

<span class="sd">    GET https://api.dataplatform.cloud.ibm.com/v2/projects/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>

<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Helper class to interact with IBM Watson Studio projects</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="ProjectLib"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ProjectLib">[docs]</a><span class="k">class</span> <span class="nc">ProjectLib</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is used by SQLClient/COSClient via :py:meth:`read` and :py:meth:`write` methods</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    project: Project</span>
<span class="sd">        The object</span>

<span class="sd">            `from project_lib import Project`</span>
<span class="sd">    file_name: str</span>
<span class="sd">        The file_name where the data about SQL queries&#39; jobs should be read/stored</span>

<span class="sd">        The content of this file is used to track progress</span>

<span class="sd">    file_type: str, optional</span>
<span class="sd">        The file format of `file_name`</span>

<span class="sd">    todo</span>
<span class="sd">    -----</span>
<span class="sd">        NOTE: Currently support only one file</span>

<span class="sd">        To support many files, we can switch to using dict such as self._data_out[file_name]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_track_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; map to real file name &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">file_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;csv&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_type</span> <span class="o">=</span> <span class="n">file_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;.csv&quot;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">file_type</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; file-like object: storing the file-content &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">project</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Project: the project-lib object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span>

<div class="viewcode-block" id="ProjectLib.read"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ProjectLib.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read from project-lib&#39;s file into file-like object</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str, optional</span>
<span class="sd">            File name in the Watson Studio&#39;s project assets. If the file is not provided, then it reads the one passed into the object&#39;s constructor.</span>

<span class="sd">        file_type: str, optional</span>
<span class="sd">            The type of file, &quot;json&quot; or &quot;csv&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        file-like object:</span>
<span class="sd">            The content of the data, in dict (json) or pd.DataFrame (csv)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span>
        <span class="c1"># Fetch the file</span>
        <span class="n">file_is_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">get_files</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filename_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">file_name</span><span class="p">:</span>
                    <span class="n">file_is_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">file_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                        <span class="c1"># Read the CSV data file from the object storage into a pandas DataFrame</span>
                        <span class="n">file_content</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="c1"># import pandas as pd</span>
                        <span class="c1"># pd.read_json(my_file, nrows=10)</span>
                        <span class="kn">import</span> <span class="nn">json</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                        <span class="c1"># Read the CSV data file from the object storage into a pandas DataFrame</span>
                        <span class="n">file_content</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_content</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_is_found</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span></div>

<div class="viewcode-block" id="ProjectLib.write"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ProjectLib.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the file-like data back to project-lib&#39;s file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str</span>
<span class="sd">            File name</span>
<span class="sd">        file_type: str, optional</span>
<span class="sd">            The type of file, &quot;json&quot; or &quot;csv&quot;</span>

<span class="sd">        Result</span>
<span class="sd">        ------</span>
<span class="sd">        dict</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {&#39;asset_id&#39;: &#39;1deebaad-8ad3-4861-8c52-e714d8eef2a9&#39;,</span>
<span class="sd">            &#39;bucket_name&#39;: &#39;projectlib351fb93e171c44369663ff79b938828d&#39;,</span>
<span class="sd">            &#39;file_name&#39;: &#39;iris1.csv&#39;,</span>
<span class="sd">            &#39;message&#39;: &#39;File iris1.csv has been written successfully to the associated OS&#39;}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span>
                                             <span class="n">out</span><span class="p">,</span>
                                             <span class="n">set_project_asset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_out</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">save_data</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span>
                                             <span class="n">out</span><span class="p">,</span>
                                             <span class="n">set_project_asset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div></div>


<span class="c1"># ---------------------------------------------------------------------------------------------</span>
<span class="c1"># Helper class to do client-side mapping of COS endpoints to aliases supported in SQL Query</span>
<span class="c1"># ---------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="ParsedUrl"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ParsedUrl">[docs]</a><span class="k">class</span> <span class="nc">ParsedUrl</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use this class to extract information from COS URL</span>

<span class="sd">        `cos://&lt;cos-name&gt;/&lt;bucket&gt;/&lt;prefix&gt;/`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_alias_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;us-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3-api.us-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;us&quot;</span><span class="p">:</span> <span class="s2">&quot;s3-api.us-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dal-us-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3-api.dal-us-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wdc-us-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3-api.wdc-us-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sjc-us-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3-api.sjc-us-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eu-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.eu-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eu&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.eu-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ams-eu-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.ams-eu-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fra-eu-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.fra-eu-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mil-eu-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.mil-eu-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;us-south&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.us-south.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;us-east&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.us-east.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;jp-tok&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.jp-tok.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ap-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.ap-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ap&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.ap-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tok-ap-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.tok-ap-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;seo-ap-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.seo-ap-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hkg-ap-geo&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.hkg-ap-geo.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eu-de&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.eu-de.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eu-gb&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.eu-gb.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ams03&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.ams03.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;che01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.che01.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mel01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.mel01.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tor01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.tor01.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mon01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.mon01.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;osl01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.osl01.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sao01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.sao01.objectstorage.softlayer.net&quot;</span><span class="p">,</span>
            <span class="s2">&quot;seo01&quot;</span><span class="p">:</span> <span class="s2">&quot;s3.seo01.objectstorage.softlayer.net&quot;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ParsedUrl.get_exact_url"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ParsedUrl.get_exact_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_exact_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;convert COS URL from using alias to exact URL&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_alias_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="ParsedUrl.get_endpoint"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ParsedUrl.get_endpoint">[docs]</a>    <span class="k">def</span> <span class="nf">get_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_alias_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span></div>

<div class="viewcode-block" id="ParsedUrl.get_bucket"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ParsedUrl.get_bucket">[docs]</a>    <span class="k">def</span> <span class="nf">get_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span></div>

<div class="viewcode-block" id="ParsedUrl.get_prefix"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ParsedUrl.get_prefix">[docs]</a>    <span class="k">def</span> <span class="nf">get_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">cos_url</span><span class="p">[</span><span class="n">cos_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fourth_slash</span> <span class="o">=</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span></div>

<div class="viewcode-block" id="ParsedUrl.analyze_cos_url"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.ParsedUrl.analyze_cos_url">[docs]</a>    <span class="k">def</span> <span class="nf">analyze_cos_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return a namedtuple containing the 3 fields</span>

<span class="sd">        * bucket</span>
<span class="sd">        * endpoint</span>
<span class="sd">        * prefix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;COSURL&quot;</span><span class="p">,</span> <span class="s2">&quot;endpoint bucket prefix&quot;</span><span class="p">)</span>
        <span class="n">mycontainer</span> <span class="o">=</span> <span class="n">nt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_endpoint</span><span class="p">(</span><span class="n">cos_url</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">cos_url</span><span class="p">),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">get_prefix</span><span class="p">(</span><span class="n">cos_url</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mycontainer</span></div></div>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Helper class to query information or manipulate data as objects on COS </span>
<span class="c1"># which can also be used from SQL Query</span>
<span class="c1"># ---------------------------------------------------------------------------</span>
<div class="viewcode-block" id="COSClient"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient">[docs]</a><span class="k">class</span> <span class="nc">COSClient</span><span class="p">(</span><span class="n">ParsedUrl</span><span class="p">,</span> <span class="n">IBMCloudAccess</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cloud_apikey : str, optional</span>
<span class="sd">        an account-level API key [manage/Access (IAM)/IBM Cloud API keys]</span>

<span class="sd">        https://cloud.ibm.com/docs/iam/users_roles.html</span>
<span class="sd">        https://cloud.ibm.com/docs/services/cloud-object-storage?topic=cloud-object-storage-getting-started</span>

<span class="sd">    cos_url : str, optional</span>
<span class="sd">        the COS URL where retrieved data is stored</span>

<span class="sd">    client_info : str, optional</span>
<span class="sd">        User-defined string</span>

<span class="sd">    See also</span>
<span class="sd">    ---------</span>

<span class="sd">        * https://cloud.ibm.com/apidocs/cos/cos-configuration</span>
<span class="sd">        * https://ibm.github.io/ibm-cos-sdk-python/</span>
<span class="sd">        * https://cloud.ibm.com/docs/services/cloud-object-storage/iam?topic=cloud-object-storage-service-credentials</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cloud_apikey</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">cos_url</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">client_info</span><span class="o">=</span><span class="s2">&quot;COS Client&quot;</span><span class="p">):</span>
        <span class="n">ParsedUrl</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">IBMCloudAccess</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">cloud_apikey</span><span class="o">=</span><span class="n">cloud_apikey</span><span class="p">,</span>
                                <span class="n">client_info</span><span class="o">=</span><span class="n">client_info</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cos_url</span> <span class="o">=</span> <span class="n">cos_url</span>
        <span class="c1"># a dict holding all retrieved bucket&#39;s information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buckets_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># track Project-Lib object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_cos_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_cos_client</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_default_cos_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a low-level service client of COS from the default session</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">_get_default_s3_client</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Create a low-level service client of COS from the default session</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">endpoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">endpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">endpoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ibm_boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span>
                                    <span class="n">config</span><span class="o">=</span><span class="n">Config</span><span class="p">(</span><span class="n">signature_version</span><span class="o">=</span><span class="s1">&#39;oauth&#39;</span><span class="p">),</span>
                                    <span class="n">endpoint_url</span><span class="o">=</span><span class="s1">&#39;https://</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">_get_default_s3_client</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>

<div class="viewcode-block" id="COSClient.list_cos_objects"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.list_cos_objects">[docs]</a>    <span class="k">def</span> <span class="nf">list_cos_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List all objects in the current COS URL.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        url: str</span>
<span class="sd">            A URI prefix. e.g., cos://us-south/&lt;bucket-name&gt;/object_path/</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The following columns (&quot;Object&quot;, &quot;Size&quot;, &quot;StorageClass&quot;)</span>

<span class="sd">        Note</span>
<span class="sd">        ------</span>
<span class="sd">        Having a trailing slash (/) makes a difference in the returned result, as an asterisk is added at the end. So,</span>
<span class="sd">        &quot;/prefix&quot; would consider things like &quot;/prefix_unexpected/value&quot; and &quot;/prefix/expected_value&quot;; while</span>
<span class="sd">        &quot;/prefix/&quot; only consider &quot;/prefix/expected_value&quot;.</span>

<span class="sd">        Examples</span>
<span class="sd">        ------------</span>
<span class="sd">            Only &quot;list_objects&#39; work for IBM COS, not &#39;list_objects_v2&#39;</span>

<span class="sd">            `IBM-COS-SDK &lt;https://ibm.github.io/ibm-cos-sdk-python/reference/services/s3.html#S3.Client.list_objects_v2&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cos_url</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span> 
            <span class="n">cos_url</span> <span class="o">=</span> <span class="n">cos_url</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">cos_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">paginator</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s2">&quot;list_objects&quot;</span><span class="p">)</span>
        <span class="n">page_iterator</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                                           <span class="n">Prefix</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">page_iterator</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Contents&quot;</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
                <span class="c1">#print(page[&#39;Contents&#39;])</span>
                <span class="n">page_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="s1">&#39;Contents&#39;</span><span class="p">],</span>
                                                 <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">page_df</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_df</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ETag&#39;</span><span class="p">,</span> <span class="s1">&#39;Owner&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;Object&quot;</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="c1"># result = pd.DataFrame(columns=[&#39;Object&#39;, &#39;LastModified&#39;, &#39;Size&#39;, &#39;StorageClass&#39;])</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="COSClient.delete_empty_objects"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.delete_empty_objects">[docs]</a>    <span class="k">def</span> <span class="nf">delete_empty_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete zero-size objects. Reference to :meth:`.list_cos_objects` for further details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_cos_objects</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span>
        <span class="n">max_row_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_objects</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_row_index</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Size</span><span class="p">[</span><span class="n">row</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cos_client</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
                                         <span class="n">Key</span><span class="o">=</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Object</span><span class="p">[</span><span class="n">row</span><span class="p">])</span></div>

<div class="viewcode-block" id="COSClient.delete_objects"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.delete_objects">[docs]</a>    <span class="k">def</span> <span class="nf">delete_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;delete all objects stored at the given COS URL</span>

<span class="sd">        https://&lt;cos-url&gt;/&lt;bucket&gt;?prefix=&lt;prefix-path&gt;</span>

<span class="sd">        Note</span>
<span class="sd">        ------</span>

<span class="sd">        Reference: `AWS doc &lt;https://awsdocs.s3.amazonaws.com/S3/latest/s3-qrc.pdf&gt;`_</span>

<span class="sd">        .. code-block:: console</span>

<span class="sd">            curl -XGET \</span>
<span class="sd">                --url &quot;https://&lt;COS-exact-URL&gt;/&lt;bucket-name&gt;?prefix=&lt;YOUR_PREFIX&gt;&quot;</span>

<span class="sd">            https://s3.us-south.objectstorage.softlayer.net/sql-query-cos-access-ts?prefix=aiops/Location=us-south/DC=rgdal10/Year=2020/Month=02/Date=06</span>

<span class="sd">            response.content returns a string in XML format</span>
<span class="sd">            -----------</span>
<span class="sd">            (&#39; response = b\&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; &#39;</span>
<span class="sd">            &#39;standalone=&quot;yes&quot;?&gt;&lt;ListBucketResult &#39; &#39;xmlns=&quot;http://s3.amazonaws.com/doc/2006-03-01/&quot;&gt;</span>
<span class="sd">            &lt;Name&gt;sql-query-cos-access-ts&lt;/Name&gt;</span>
<span class="sd">            &lt;Prefix&gt;aiops/Location=us-south/DC=rgdal10/Year=2020/Month=02/Date=05&lt;/Prefix&gt;</span>
<span class="sd">            &lt;Marker&gt;&lt;/Marker&gt;</span>
<span class="sd">            &lt;MaxKeys&gt;1000&lt;/MaxKeys&gt;</span>
<span class="sd">            &lt;Delimiter&gt;&lt;/Delimiter&gt;</span>
<span class="sd">            &lt;IsTruncated&gt;false&lt;/IsTruncated&gt;</span>

<span class="sd">            --&gt; 0 or more</span>
<span class="sd">            &lt;Contents&gt;</span>
<span class="sd">                   &lt;Key&gt;aiops/Location=us-south/DC=rgdal10/Year=2020/Month=02/Date=05/Hour=1/part-00066-fd76d4c7-ea0a-40c3-8170-8f281a19ab5f-attempt_20200310232241_0027_m_000066_0.c000.snappy.parquet&lt;/Key&gt;</span>
<span class="sd">                   &lt;LastModified&gt;2020-03-10T23:26:55.957Z&lt;/LastModified&gt;</span>
<span class="sd">                   &lt;ETag&gt;&amp;quot;9b9c012a341fe7f4b9988c59cab96757&amp;quot;&lt;/ETag&gt;</span>
<span class="sd">                   &lt;Size&gt;1771294485&lt;/Size&gt;</span>
<span class="sd">                   &lt;Owner&gt;</span>
<span class="sd">                        &lt;ID&gt;899ab340-5a4d-4ae2-a1f7-5e39299735b4&lt;/ID&gt;</span>
<span class="sd">                        &lt;DisplayName&gt;899ab340-5a4d-4ae2-a1f7-5e39299735b4&lt;/DisplayName&gt;&lt;/Owner&gt;</span>
<span class="sd">                   &lt;StorageClass&gt;STANDARD&lt;/StorageClass&gt;&lt;/Contents&gt;</span>

<span class="sd">            &lt;/ListBucketResult&gt;\&#39;&#39;)</span>

<span class="sd">        As the entity tag (ETag) is a hash of the object, we can use it to reliably check whether the object has changed - better</span>
<span class="sd">        than just file size and modification date. Sample code to handle `request.response &lt;https://sdbrett.com/BrettsITBlog/2017/03/python-parsing-api-xml-response-data/&gt;`_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;COS URL: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_url</span><span class="p">))</span>
        <span class="n">cos_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">result_location</span> <span class="o">=</span> <span class="n">cos_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;cos&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>

        <span class="n">fourth_slash</span> <span class="o">=</span> <span class="n">result_location</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="n">http_string</span> <span class="o">=</span> <span class="n">result_location</span><span class="p">[:</span>
                                      <span class="n">fourth_slash</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;?prefix=&#39;</span> <span class="o">+</span> <span class="n">result_location</span><span class="p">[</span>
                                          <span class="n">fourth_slash</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">http_string</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pprint</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;http request </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">http_string</span><span class="p">))</span>
            <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="s2">&quot; response = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;s3&#39;</span><span class="p">:</span> <span class="s1">&#39;http://s3.amazonaws.com/doc/2006-03-01/&#39;</span><span class="p">}</span>
            <span class="n">responseBodyXMLroot</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">responseBodyXMLroot</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;s3:Name&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">bucket_objects</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">responseBodyXMLroot</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;s3:Contents&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">contents</span> <span class="ow">in</span> <span class="n">responseBodyXMLroot</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;s3:Contents&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;s3:Key&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
                    <span class="n">bucket_objects</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="o">.</span><span class="n">text</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;There are no result objects for the COS URL </span><span class="si">{url}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">cos_url</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Result object listing for COS URL at </span><span class="si">{}</span><span class="s2"> failed with http code </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result_location</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dry_run</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">cos_client</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cos_client</span><span class="p">)</span>
            <span class="n">deleted_list_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Deleted Object&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">delete_objects</span><span class="p">(</span>
                <span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">Delete</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Objects&#39;</span><span class="p">:</span> <span class="n">bucket_objects</span><span class="p">})</span>

            <span class="n">deleted_list_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Deleted Object&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">deleted_object</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Deleted&#39;</span><span class="p">]:</span>
                <span class="n">deleted_list_df</span> <span class="o">=</span> <span class="n">deleted_list_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[{</span>
                        <span class="s1">&#39;Deleted Object&#39;</span><span class="p">:</span> <span class="n">deleted_object</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span>
                    <span class="p">}],</span>
                    <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">deleted_list_df</span></div>

    <span class="k">def</span> <span class="nf">_list_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all objects from a given COS URL</span>

<span class="sd">        TO BE REMOVED</span>

<span class="sd">        Arguments:</span>
<span class="sd">            cos_url {str} -- The COS URL</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

        <span class="n">cos_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">paginator</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s2">&quot;list_objects&quot;</span><span class="p">)</span>
        <span class="n">page_iterator</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                                           <span class="n">Prefix</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">page_iterator</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Contents&quot;</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
                <span class="c1">#print(page[&#39;Contents&#39;])</span>
                <span class="n">page_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="s1">&#39;Contents&#39;</span><span class="p">],</span>
                                                 <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">page_df</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_df</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ETag&#39;</span><span class="p">,</span> <span class="s1">&#39;Owner&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;Object&quot;</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="COSClient.get_bucket_info"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.get_bucket_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_bucket_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. code-block:: console</span>

<span class="sd">            curl https://config.cloud-object-storage.cloud.ibm.com/v1/b/my-bucket \</span>
<span class="sd">            -H &#39;authorization: bearer &lt;IAM_token&gt;&#39;</span>

<span class="sd">        200 status code:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {</span>
<span class="sd">            &quot;name&quot;: &quot;my-new-bucket&quot;,</span>
<span class="sd">            &quot;crn&quot;: &quot;crn:v1:bluemix:public:cloud-object-storage:global:a/ 3bf0d9003abfb5d29761c3e97696b71c:xxxxxxx-6c4f-4a62-a165-696756d63903:bucket:my-new-bucket&quot;,</span>
<span class="sd">            &quot;service_instance_id&quot;: &quot;xxxxxxx-6c4f-4a62-a165-696756d63903&quot;,</span>
<span class="sd">            &quot;service_instance_crn&quot;: &quot;crn:v1:bluemix:public:cloud-object-storage:global:a/3bf0d9003abfb5d29761c3e97696b71c:xxxxxxx-6c4f-4a62-a165-696756d63903::&quot;,</span>
<span class="sd">            &quot;time_created&quot;: &quot;2018-03-26T16:23:36.980Z&quot;,</span>
<span class="sd">            &quot;time_updated&quot;: &quot;2018-10-17T19:29:10.117Z&quot;,</span>
<span class="sd">            &quot;object_count&quot;: 764265234,</span>
<span class="sd">            &quot;bytes_used&quot;: 28198745752445144</span>
<span class="sd">            }</span>

<span class="sd">        todo</span>
<span class="sd">        ----</span>
<span class="sd">            https://cloud.ibm.com/apidocs/cos/cos-configuration?code=python</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">cos_config.resource_configuration_v1</span> <span class="kn">import</span> <span class="n">ResourceConfigurationV1</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buckets_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buckets_info</span><span class="p">[</span><span class="n">bucket</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">ResourceConfigurationV1</span><span class="p">(</span><span class="n">iam_apikey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apikey</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_bucket_config</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buckets_info</span><span class="p">[</span><span class="n">bucket</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
            <span class="k">return</span> <span class="n">config</span></div>
        <span class="c1"># bucket = ParsedUrl().get_bucket(cos_url)</span>
        <span class="c1"># response = requests.get(</span>
        <span class="c1">#     &quot;https://config.cloud-object-storage.cloud.ibm.com/v1/b/{bucket}&quot;.</span>
        <span class="c1">#     format(bucket=bucket),</span>
        <span class="c1">#     headers=self.request_headers,</span>
        <span class="c1"># )</span>

        <span class="c1"># if response.status_code == 200 or response.status_code == 201:</span>
        <span class="c1">#     status_response = response.json()</span>
        <span class="c1">#     jobStatus = status_response[&#39;status&#39;]</span>
        <span class="c1">#     if jobStatus == &#39;completed&#39;:</span>
        <span class="c1">#         break</span>
        <span class="c1">#     if jobStatus == &#39;failed&#39;:</span>
        <span class="c1">#         print(&quot;Job {} has failed&quot;.format(jobId))</span>
        <span class="c1">#         break</span>
        <span class="c1"># else:</span>
        <span class="c1">#     print(&quot;Job status check failed with http code {}&quot;.format(</span>
        <span class="c1">#         response.status_code))</span>
        <span class="c1">#     break</span>
        <span class="c1"># time.sleep(2)</span>

<div class="viewcode-block" id="COSClient.update_bucket"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.update_bucket">[docs]</a>    <span class="k">def</span> <span class="nf">update_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        todo</span>
<span class="sd">        ----</span>
<span class="sd">           revise this</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">cos_config.resource_configuration_v1</span> <span class="kn">import</span> <span class="n">ResourceConfigurationV1</span>

        <span class="n">api_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apikey</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>

        <span class="n">client</span> <span class="o">=</span> <span class="n">ResourceConfigurationV1</span><span class="p">(</span><span class="n">iam_apikey</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>

        <span class="n">client</span><span class="o">.</span><span class="n">update_bucket_config</span><span class="p">(</span>
            <span class="n">bucket</span><span class="p">,</span>
            <span class="n">firewall</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;allowed_ip&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;10.142.175.0/22&quot;</span><span class="p">,</span> <span class="s2">&quot;10.198.243.79&quot;</span><span class="p">]})</span></div>

    <span class="c1"># -----------------</span>
    <span class="c1"># The methods below are for interacting with a file stored as an asset in a Watson Studio&#39;s Project.</span>
    <span class="c1"># -----------------</span>
<div class="viewcode-block" id="COSClient.connect_project_lib"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.connect_project_lib">[docs]</a>    <span class="k">def</span> <span class="nf">connect_project_lib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect to an IBM Watson Studio Project&#39;s COS bucket for its own assets</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        project: Project</span>
<span class="sd">            The project-lib object</span>

<span class="sd">        file_name: str, optional</span>
<span class="sd">            The name of the file in ProjectLib&#39;s COS bucket where data will be read/stored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="o">=</span> <span class="n">ProjectLib</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_project_lib_data</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="COSClient.read_project_lib_data"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.read_project_lib_data">[docs]</a>    <span class="k">def</span> <span class="nf">read_project_lib_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;read the content from the given file (via ProjectLib in IBM Watson Studio&#39;s COS bucket)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str, optional</span>
<span class="sd">            If not specified, use the one defined from the beginning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please connect to your ProjectLib object with `connect_project_lib` API&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="COSClient.write_project_lib_data"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.cos.COSClient.write_project_lib_data">[docs]</a>    <span class="k">def</span> <span class="nf">write_project_lib_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;write the content to the given file (via ProjectLib in IBM Watson Studio&#39;s COS bucket)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name: str, optional</span>
<span class="sd">            If not specified, use the one defined from the beginning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please connect to your ProjectLib object with `connect_project_lib` API&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_project</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">project_lib</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Project: IBM Watson Studio ProjectLib object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_project</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">cos</span> <span class="o">=</span> <span class="n">COSClient</span><span class="p">()</span>
    <span class="n">cos_url</span> <span class="o">=</span> <span class="s2">&quot;cos://us-south/sql-query-cos-access-ts/aiops_test/Location=us-south/DC=rgfra02/Year=2019/Month=10/Date=23/Hour=01/&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;From: &quot;</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;To : &quot;</span><span class="p">,</span> <span class="n">cos</span><span class="o">.</span><span class="n">get_exact_url</span><span class="p">(</span><span class="n">cos_url</span><span class="p">))</span>

    <span class="n">cos_url</span> <span class="o">=</span> <span class="s2">&quot;cos://s3.us-south.cloud-object-storage.appdomain.cloud/sql-query-cos-access-ts/aiops_test/Location=eu-de/DC=rgfra02/Year=2019/Month=10/Date=23/Hour=01/&quot;</span>
    <span class="n">cos</span><span class="o">.</span><span class="n">delete_objects</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2020, IBM Research.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>
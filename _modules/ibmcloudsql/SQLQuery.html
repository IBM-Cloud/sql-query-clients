
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>ibmcloudsql.SQLQuery &#8212; SQLClient alpha documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/custom.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">SQLClient</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../includeme.html">README</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">ibmcloudsql.utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cos.html">ibmcloudsql.cos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql_magic.html">ibmcloudsql.sql_magic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql_query.html">ibmcloudsql.SQLQuery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">ibmcloudsql</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ibmcloudsql.SQLQuery</h1><div class="highlight"><pre>
<span></span><span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Copyright IBM Corp. 2020</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">backoff</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">HTTPError</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ibm_botocore.client</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">import</span> <span class="nn">ibm_boto3</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pyarrow</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">exceptions</span> <span class="kn">import</span> <span class="n">RateLimitedException</span><span class="p">,</span> <span class="n">CosUrlNotFoundException</span><span class="p">,</span> <span class="n">SqlQueryCrnInvalidFormatException</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">RateLimitedException</span><span class="p">,</span> <span class="n">CosUrlNotFoundException</span><span class="p">,</span> <span class="n">SqlQueryCrnInvalidFormatException</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.cos</span> <span class="kn">import</span> <span class="n">COSClient</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cos</span> <span class="kn">import</span> <span class="n">COSClient</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sql_magic</span> <span class="kn">import</span> <span class="n">SQLMagic</span><span class="p">,</span> <span class="n">format_sql</span><span class="p">,</span> <span class="n">print_sql</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.sql_magic</span> <span class="kn">import</span> <span class="n">SQLMagic</span><span class="p">,</span> <span class="n">format_sql</span><span class="p">,</span> <span class="n">print_sql</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.catalog_table</span> <span class="kn">import</span> <span class="n">HiveMetastore</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">catalog_table</span> <span class="kn">import</span> <span class="n">HiveMetastore</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">JSONDecodeError</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">dateutil.parser</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">sqlparse</span>

<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<div class="viewcode-block" id="validate_job_status"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.validate_job_status">[docs]</a><span class="k">def</span> <span class="nf">validate_job_status</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;check if input about job status, via `status` argument is corrected&quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getcallargs</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span>
            <span class="s1">&#39;status&#39;</span><span class="p">]</span>
        <span class="n">supported_job_status</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_job_status</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`status` must be a value in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">supported_job_status</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapped</span></div>

<div class="viewcode-block" id="check_saved_jobs_decorator"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.check_saved_jobs_decorator">[docs]</a><span class="k">def</span> <span class="nf">check_saved_jobs_decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;a decorator that load data from ProjectLib, check for completed SQL</span>
<span class="sd">    Query job, before deciding to launch it&quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getcallargs</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span>
            <span class="s1">&#39;file_name&#39;</span><span class="p">]</span>  <span class="c1"># Gets you the username, default or modifed</span>
        <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span><span class="s2">&quot;sql_stmt&quot;</span><span class="p">]</span>
        <span class="c1"># refine query</span>
        <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">format_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>

        <span class="n">run_as_usual</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_lib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># handle here</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_lib</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_project_lib_data</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
                <span class="n">keys_mapping</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># refine existing data</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_lib</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">new_key</span> <span class="o">=</span> <span class="n">format_sql</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">new_key</span><span class="p">:</span>
                        <span class="n">keys_mapping</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_key</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys_mapping</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rename_keys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_lib</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">keys_mapping</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sql_stmt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_lib</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="n">run_as_usual</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_lib</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sql_stmt</span><span class="p">][</span><span class="s2">&quot;job_id&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_lib</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sql_stmt</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;completed&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Job </span><span class="si">{}</span><span class="s2"> completed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># query the status</span>
                    <span class="n">job_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project_lib</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sql_stmt</span><span class="p">][</span><span class="s2">&quot;job_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_result</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project_lib</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sql_stmt</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_result</span><span class="p">[</span>
                            <span class="s2">&quot;status&quot;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">pprint</span>
                        <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">job_result</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">e</span>
                    <span class="k">if</span> <span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
                        <span class="n">run_as_usual</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">run_as_usual</span><span class="p">:</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_lib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_lib</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">sql_stmt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;running&quot;</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_project_lib_data</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">job_id</span>

    <span class="k">return</span> <span class="n">wrapped</span></div>


<div class="viewcode-block" id="SQLQuery"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery">[docs]</a><span class="k">class</span> <span class="nc">SQLQuery</span><span class="p">(</span><span class="n">COSClient</span><span class="p">,</span> <span class="n">SQLMagic</span><span class="p">,</span> <span class="n">HiveMetastore</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The class the provides necessary APIs to interact with</span>

<span class="sd">    1. IBM SQL Serverless service</span>
<span class="sd">    2. IBM COS service</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    apikey : str, optional</span>
<span class="sd">        an account-level API key [manage/Access (IAM)/IBM Cloud API keys]</span>
<span class="sd">    instance_crn :str, optional</span>
<span class="sd">        CRN from SQLQuery instance</span>
<span class="sd">    target_cos_url : str, optional</span>
<span class="sd">        the URI where retrieved data is stored</span>
<span class="sd">    max_concurrent_jobs: int, optional</span>
<span class="sd">        the max number of concurrent jobs</span>
<span class="sd">    client_info : str, optional</span>
<span class="sd">        User-defined string</span>
<span class="sd">    max_tries: int, optional</span>
<span class="sd">        The number of time :meth:`.submit_sql`, should try to request CloudSQL before giving up.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">instance_crn</span><span class="p">,</span> <span class="n">target_cos_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">client_info</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">max_concurrent_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="n">max_tries</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">COSClient</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">cloud_apikey</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span>
                           <span class="n">cos_url</span><span class="o">=</span><span class="n">target_cos_url</span><span class="p">,</span>
                           <span class="n">client_info</span><span class="o">=</span><span class="n">client_info</span><span class="p">)</span>
        <span class="n">SQLMagic</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">HiveMetastore</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_cos_url</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instance_crn</span> <span class="o">=</span> <span class="n">instance_crn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span> <span class="o">=</span> <span class="n">target_cos_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_cos_url</span> <span class="o">=</span> <span class="n">target_cos_url</span>
        <span class="k">if</span> <span class="n">client_info</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_agent</span> <span class="o">=</span> <span class="s1">&#39;IBM Cloud SQL Query Python SDK&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_agent</span> <span class="o">=</span> <span class="n">client_info</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span> <span class="o">=</span> <span class="n">max_tries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_concurrent_jobs</span> <span class="o">=</span> <span class="n">max_concurrent_jobs</span>  <span class="c1"># the current maximum concurrent jobs</span>

        <span class="c1"># track the status of jobs - save the time to SQLQuery server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs_tracking</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SQLClient created successful&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">my_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return information about jobs already queried via :meth:`.get_job`</span>
<span class="sd">        issued by this SQLClient class object</span>

<span class="sd">        This is different from :py:meth:`.get_jobs`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs_tracking</span>

<div class="viewcode-block" id="SQLQuery.configure"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apikey</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">instance_crn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cos_out_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; use this to update the configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">COSClient</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apikey</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">instance_crn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_crn</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="s1">&#39;Enter SQL Query Instance CRN (leave empty to use previous one): &#39;</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_crn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance_crn</span> <span class="o">=</span> <span class="n">instance_crn</span>
        <span class="k">if</span> <span class="n">cos_out_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter target URI for SQL results: &#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                    <span class="s1">&#39;Enter target URI for SQL results (leave empty to use &#39;</span> <span class="o">+</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span> <span class="o">+</span> <span class="s1">&#39;): &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cos_out_url</span> <span class="o">=</span> <span class="n">cos_out_url</span>
        <span class="n">HiveMetastore</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_response_error_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;errors&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># if we get the error from some intermediate proxy, it may</span>
            <span class="c1"># not match the SQLQuery error format</span>
            <span class="k">return</span> <span class="s2">&quot;Non-parseable error: </span><span class="si">{txt}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">txt</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">200</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">_send_req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;send SQL data to API. return job id&#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="s2">&quot;https://api.sql-query.cloud.ibm.com/v2/sql_jobs?instance_crn=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_crn</span><span class="p">),</span>
                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="n">json_data</span><span class="p">)</span>

            <span class="c1"># Throw in case we hit the rate limit</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># seconds</span>
                <span class="k">raise</span> <span class="n">RateLimitedException</span><span class="p">(</span>
                    <span class="s2">&quot;SQL submission failed (</span><span class="si">{code}</span><span class="s2">): </span><span class="si">{msg}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                        <span class="n">msg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_response_error_msg</span><span class="p">(</span><span class="n">response</span><span class="p">)))</span>

            <span class="c1"># any other error but 429 will be raised here, like 403 etc</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

            <span class="n">resp</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;job_id&#39;</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;Response </span><span class="si">{resp}</span><span class="s2"> contains no job ID&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">resp</span><span class="o">=</span><span class="n">resp</span>
                <span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">HTTPError</span><span class="p">)</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_error_msg</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;SQL submission failed (</span><span class="si">{code}</span><span class="s2">): </span><span class="si">{msg}</span><span class="s2"> - </span><span class="si">{query}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                    <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
                    <span class="n">query</span><span class="o">=</span><span class="n">pformat</span><span class="p">(</span><span class="n">json_data</span><span class="p">))</span>
            <span class="n">crn_error</span> <span class="o">=</span> <span class="s2">&quot;Service CRN has an invalid format&quot;</span>
            <span class="k">if</span> <span class="n">crn_error</span> <span class="ow">in</span> <span class="n">error_message</span><span class="p">:</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;SQL submission failed (</span><span class="si">{code}</span><span class="s2">): </span><span class="si">{msg}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                        <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">SqlQueryCrnInvalidFormatException</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>

<div class="viewcode-block" id="SQLQuery.submit"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.submit">[docs]</a>    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; run the internal SQL statement that you created using the APIs provided by SQLMagic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql_stmt</span><span class="p">,</span>
            <span class="n">pagesize</span><span class="o">=</span><span class="n">pagesize</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLQuery.submit_sql"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.submit_sql">[docs]</a>    <span class="k">def</span> <span class="nf">submit_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql_stmt</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronous call - submit and quickly return the job_id.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sql_stmt: str</span>
<span class="sd">            SQL Query string</span>
<span class="sd">        pagesize: int, optional</span>
<span class="sd">            an integer indicating the number of rows for each partition/page</span>
<span class="sd">            [using PARTITIONED EVERY &lt;pagesize&gt; ROWS syntax]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            job_id</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RateLimitedException</span>
<span class="sd">            when the SQLQUery instance is serving the max-limit of requests</span>

<span class="sd">        SyntaxError</span>
<span class="sd">            for both KeyError or HTTPError</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>

<span class="sd">        .. code-block:: console</span>

<span class="sd">            curl -XPOST \</span>
<span class="sd">                --url &quot;https://api.sql-query.cloud.ibm.com/v2/sql_jobs?instance_crn=YOUR_SQL_QUERY_CRN&quot; \</span>
<span class="sd">                -H &quot;Accept: application/json&quot; \</span>
<span class="sd">                -H &quot;Authorization: Bearer YOUR_BEARER_TOKEN&quot; \</span>
<span class="sd">                -H &quot;Content-Type: application/json&quot; \</span>
<span class="sd">                -d &#39;{&quot;statement&quot;:&quot;SELECT firstname FROM cos://us-geo/sql/employees.parquet STORED AS PARQUET WHERE EMPLOYEEID=5 INTO cos://us-geo/target-bucket/q1-results&quot; }&#39;</span>

<span class="sd">        NOTE:</span>

<span class="sd">        1. All the headers (-H) can be put into a dictionary and</span>
<span class="sd">        passed to the *headers* argument of requests.post() API.</span>

<span class="sd">        2. All the data (-d option) is put into a dictionary and</span>
<span class="sd">        passed to the *json* argument of requests.post() API.</span>

<span class="sd">            * &#39;statement&#39;: value is full SQL statement in string</span>
<span class="sd">            * &#39;resultset_target&#39; (optional): only need when there is no &#39;INTO statement&#39; in the query string, and the value must be the COS URL output</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            sqlData = {&#39;statement&#39;: sql_stmt}</span>
<span class="sd">            request_headers = {&#39;Content-Type&#39;: &#39;application/json&#39;}</span>
<span class="sd">            request_headers.update({&#39;Accept&#39;:&#39;application/json&#39;})</span>
<span class="sd">            request_headers.update({&#39;User-Agent&#39;: self.user_agent})</span>
<span class="sd">            request_headers.update({&#39;authorization&#39;: &#39;Bearer {}&#39;.format(ro_credentials.token)})</span>
<span class="sd">            response = requests.post(</span>
<span class="sd">                &quot;https://api.sql-query.cloud.ibm.com/v2/sql_jobs?instance_crn={}&quot;.format(self.instance_crn),</span>
<span class="sd">                headers=request_headers,</span>
<span class="sd">                json=sqlData)</span>
<span class="sd">            \&quot;\&quot;\&quot;</span>
<span class="sd">            {</span>
<span class="sd">                &quot;errors&quot;: [</span>
<span class="sd">                    {</span>
<span class="sd">                    &quot;code&quot;: &quot;bad_request&quot;,</span>
<span class="sd">                    &quot;message&quot;: &quot;Target url specified in parameter resultset_target and as part of into clause in statement&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                ]</span>
<span class="sd">            }</span>
<span class="sd">            {</span>
<span class="sd">                &quot;job_id&quot;: &quot;e2adca0a-9247-4cfa-ac58-db4b2bc33a01&quot;,</span>
<span class="sd">                &quot;status&quot;: &quot;queued&quot;</span>
<span class="sd">            }</span>
<span class="sd">            {</span>
<span class="sd">                &quot;status_code&quot;: 429,</span>
<span class="sd">                &quot;errors&quot;: [</span>
<span class="sd">                    {</span>
<span class="sd">                    &quot;code&quot;: &quot;too_many_requests&quot;,</span>
<span class="sd">                    &quot;message&quot;: &quot;This instance is currently running its maximum number of query jobs. Try again later, after at least one of the currently running jobs has completed.&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                ]</span>
<span class="sd">            }</span>
<span class="sd">            \&quot;\&quot;\&quot;</span>
<span class="sd">            # error code information: https://cloud.ibm.com/apidocs/sql-query</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>
        <span class="n">sql_text</span> <span class="o">=</span> <span class="n">sql_stmt</span>
        <span class="n">sqlData</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;statement&#39;</span><span class="p">:</span> <span class="n">sql_text</span><span class="p">}</span>

        <span class="k">def</span> <span class="nf">INTO_is_present</span><span class="p">(</span><span class="n">sql_text</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; check if INTO keyword is present in the SQL query&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot; INTO &quot;</span> <span class="ow">in</span> <span class="n">sql_text</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">INTO &quot;</span> <span class="ow">in</span> <span class="n">sql_text</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

        <span class="c1"># If a valid pagesize is specified we need to append the proper PARTITIONED EVERY &lt;num&gt; ROWS clause</span>
        <span class="k">if</span> <span class="n">pagesize</span> <span class="ow">or</span> <span class="n">pagesize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pagesize</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">pagesize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">INTO_is_present</span><span class="p">(</span><span class="n">sql_text</span><span class="p">):</span>
                    <span class="n">sqlData</span><span class="p">[</span><span class="s2">&quot;statement&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; INTO </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">INTO_is_present</span><span class="p">(</span><span class="n">sql_text</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span>
                        <span class="s2">&quot;Neither resultset_target parameter nor </span><span class="se">\&quot;</span><span class="s2">INTO</span><span class="se">\&quot;</span><span class="s2"> clause specified.&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot; PARTITIONED &quot;</span> <span class="ow">in</span> <span class="n">sql_text</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span>
                        <span class="s2">&quot;Must not use PARTITIONED clause when specifying pagesize parameter.&quot;</span>
                    <span class="p">)</span>
                <span class="n">sqlData</span><span class="p">[</span><span class="s2">&quot;statement&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; PARTITIONED EVERY </span><span class="si">{}</span><span class="s2"> ROWS&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">pagesize</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;pagesize parameter (</span><span class="si">{}</span><span class="s1">) is not valid.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pagesize</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">INTO_is_present</span><span class="p">(</span><span class="n">sql_text</span><span class="p">):</span>
            <span class="n">sqlData</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;resultset_target&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span><span class="p">})</span>

        <span class="n">max_tries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tries</span>
        <span class="n">intrumented_send</span> <span class="o">=</span> <span class="n">backoff</span><span class="o">.</span><span class="n">on_exception</span><span class="p">(</span>
            <span class="n">backoff</span><span class="o">.</span><span class="n">expo</span><span class="p">,</span>
            <span class="n">RateLimitedException</span><span class="p">,</span>
            <span class="n">max_tries</span><span class="o">=</span><span class="n">max_tries</span>
        <span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_send_req</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">intrumented_send</span><span class="p">(</span><span class="n">sqlData</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLQuery.submit_and_track_sql"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.submit_and_track_sql">[docs]</a>    <span class="nd">@check_saved_jobs_decorator</span>
    <span class="k">def</span> <span class="nf">submit_and_track_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql_stmt</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When using SQL Query client via Watson Studio, you are limited to the</span>
<span class="sd">        session time provided by the system. This may be a problem when you</span>
<span class="sd">        launch many SQL Query jobs, as such limitation may prevent you to</span>
<span class="sd">        complete all of them in one session.</span>

<span class="sd">        This API provides the capability to put the information of each</span>
<span class="sd">        launched jobs in a `file_name` stored as an asset in the Watson</span>
<span class="sd">        Studio&#39;s Project. Whenever you launch a `sql_stmt` via this API, and</span>
<span class="sd">        you also provide the `file_name`, the SQL Query client will check the</span>
<span class="sd">        content of such file name to see if the given `sql_stmt` has been</span>
<span class="sd">        launched, and if so, whether it is completed or not. If not</span>
<span class="sd">        completed, then it relaunches the job, and update the content in this</span>
<span class="sd">        file. Otherwise, it skips the `sql_stmt`.</span>

<span class="sd">        To check if a `sql_stmt` has been issued or not, the</span>
<span class="sd">        :func:`.format_sql` transforms the query string into a style that can</span>
<span class="sd">        be used for string comparison that is tolerance to white spaces, new</span>
<span class="sd">        lines, comments, lower-case or upper-case uses in the query string.</span>
<span class="sd">        This is done by the decorator :meth:`check_saved_jobs_decorator`.</span>

<span class="sd">        This is beneficial in the scenario when you launch many many jobs, and don&#39;t want to restart from the beginning.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sql_stmt: str</span>
<span class="sd">            sql string</span>
<span class="sd">        pagesize: int, optional</span>
<span class="sd">            the page size</span>
<span class="sd">        file_name: str, optional</span>
<span class="sd">            If it is used, it will looks into the ProjectLib for an asset file name $file_name.json and compare the full sql statement if it has been used.</span>
<span class="sd">            If yes, and the result is successful, there is no need to rerun it.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">            To use this API, the SQL Query client must already connected to the ProjectLib object via :meth:`.connect_project_lib` method.</span>

<span class="sd">            This APIs make use of :py:meth:`.COSClient.connect_project_lib`, :py:meth:`.COSClient.read_project_lib_data`.</span>

<span class="sd">        Todo</span>
<span class="sd">        ------</span>
<span class="sd">            If SQL Query client is used from a local machine, the `file_name` can be a file on the user&#39;s local machine.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_sql</span><span class="p">(</span>
            <span class="n">sql_stmt</span><span class="p">,</span>
            <span class="n">pagesize</span><span class="o">=</span><span class="n">pagesize</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLQuery.wait_for_job"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.wait_for_job">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        It&#39;s possible that the job&#39;s failed because of Spark&#39;s internal error.</span>
<span class="sd">        So &quot;unknown&quot; is added for such cases.</span>

<span class="sd">        Return</span>
<span class="sd">        -------</span>
<span class="sd">            &#39;failed&#39;, &#39;completed&#39;, or &#39;unknown&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">wait_for_job</span><span class="p">(</span><span class="n">jobId</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;https://api.sql-query.cloud.ibm.com/v2/sql_jobs/</span><span class="si">{}</span><span class="s2">?instance_crn=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_crn</span><span class="p">),</span>
                    <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
                    <span class="n">status_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="n">jobStatus</span> <span class="o">=</span> <span class="n">status_response</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">jobStatus</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">jobStatus</span> <span class="o">==</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Job </span><span class="si">{}</span><span class="s2"> has failed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobId</span><span class="p">))</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Job status check failed with http code </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jobStatus</span>

        <span class="n">job_id</span> <span class="o">=</span> <span class="n">jobId</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">wait_for_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnboundLocalError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="k">return</span> <span class="n">x</span></div>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

<div class="viewcode-block" id="SQLQuery.get_result"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.get_result">[docs]</a>    <span class="k">def</span> <span class="nf">get_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobId</span><span class="p">,</span> <span class="n">pagenumber</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        jobId: int</span>
<span class="sd">            The value, if not stored, can be retrieved from :meth:`.get_jobs`</span>
<span class="sd">        pagenumber: int, optional</span>
<span class="sd">            If the data, from the given `job_id` is saved in pages/partitions, then this should be a value</span>
<span class="sd">            in the range from 1 to len(self.list_results(job_id))</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataframe</span>
<span class="sd">            The dataframe holding the queried data from a completed job</span>


<span class="sd">        .. code-block:: console</span>

<span class="sd">            curl -XGET \</span>
<span class="sd">                --url &quot;https://api.sql-query.cloud.ibm.com/v2/sql_jobs?instance_crn=&lt;YOUR_SQL_QUERY_CRN&gt;&quot; \</span>
<span class="sd">                -H &quot;Accept: application/json&quot; \</span>
<span class="sd">                -H &quot;Authorization: Bearer &lt;YOUR_BEARER_TOKEN&gt;&quot;  \</span>
<span class="sd">                -H &quot;Content-Type: application/json&quot;</span>

<span class="sd">            \&quot;\&quot;\&quot;</span>
<span class="sd">            {</span>
<span class="sd">            &quot;jobs&quot;: [</span>
<span class="sd">                {</span>
<span class="sd">                &quot;job_id&quot;: &quot;7ebed7f7-00dc-44a2-acfa-5bdb53889648&quot;,</span>
<span class="sd">                &quot;status&quot;: &quot;completed&quot;,</span>
<span class="sd">                &quot;submit_time&quot;: &quot;2018-08-14T08:45:54.012Z&quot;,</span>
<span class="sd">                &quot;user_id&quot;: &quot;user1@ibm.com&quot;</span>
<span class="sd">                },</span>
<span class="sd">                {</span>
<span class="sd">                &quot;job_id&quot;: &quot;ffde4c5a-1cc2-448b-b377-43573818e5d8&quot;,</span>
<span class="sd">                &quot;status&quot;: &quot;completed&quot;,</span>
<span class="sd">                &quot;submit_time&quot;: &quot;2018-08-14T08:47:33.350Z&quot;,</span>
<span class="sd">                &quot;user_id&quot;: &quot;user1@ibm.com&quot;</span>
<span class="sd">                }</span>
<span class="sd">            ]</span>
<span class="sd">            }</span>
<span class="sd">            \&quot;\&quot;\&quot;</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            response = requests.get(</span>
<span class="sd">                &quot;https://api.sql-query.cloud.ibm.com/v2/sql_jobs/{}?instance_crn={}&quot;.format(jobId, self.instance_crn),</span>
<span class="sd">                headers=self.request_headers,</span>
<span class="sd">            )</span>

<span class="sd">            if response.status_code == 200 or response.status_code == 201:</span>
<span class="sd">                status_response = response.json()</span>

<span class="sd">            https://cloud.ibm.com/apidocs/sql-query#run-an-sql-job</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

        <span class="n">job_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">jobId</span><span class="p">)</span>
        <span class="n">job_status</span> <span class="o">=</span> <span class="n">job_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_status</span> <span class="o">==</span> <span class="s1">&#39;running&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SQL job with jobId </span><span class="si">{}</span><span class="s1"> still running. Come back later.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobId</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">job_status</span> <span class="o">!=</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SQL job with jobId </span><span class="si">{}</span><span class="s1"> did not finish successfully. No result available.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobId</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;resultset_location&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_details</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;resultset_location&#39;</span><span class="p">])</span>
        <span class="n">result_location</span> <span class="o">=</span> <span class="s2">&quot;https://</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">?prefix=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">result_format</span> <span class="o">=</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;resultset_format&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">result_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Result object format </span><span class="si">{}</span><span class="s2"> currently not supported by get_result().&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result_format</span><span class="p">))</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">result_location</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;s3&#39;</span><span class="p">:</span> <span class="s1">&#39;http://s3.amazonaws.com/doc/2006-03-01/&#39;</span><span class="p">}</span>
            <span class="n">responseBodyXMLroot</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="n">bucket_objects</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Find result objects with data</span>
            <span class="k">for</span> <span class="n">contents</span> <span class="ow">in</span> <span class="n">responseBodyXMLroot</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;s3:Contents&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;s3:Key&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;s3:Size&#39;</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bucket_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="c1">#print(&quot;Job result for {} stored at: {}&quot;.format(jobId, result_object))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Result object listing for job </span><span class="si">{}</span><span class="s2"> at </span><span class="si">{}</span><span class="s2"> failed with http code </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobId</span><span class="p">,</span> <span class="n">result_location</span><span class="p">,</span>
                                                                                           <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>

        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>

        <span class="c1"># When pagenumber is specified we only retrieve that page. Otherwise we concatenate all pages to one DF:</span>
        <span class="k">if</span> <span class="n">pagenumber</span> <span class="ow">or</span> <span class="n">pagenumber</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot; PARTITIONED EVERY &quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;statement&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pagenumber (</span><span class="si">{}</span><span class="s2">) specified, but the job was not submitted with pagination option.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pagenumber</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pagenumber</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">pagenumber</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bucket_objects</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">result_format</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">bucket_objects</span><span class="p">[</span><span class="n">pagenumber</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="s1">&#39;Body&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span> <span class="n">body</span><span class="o">.</span><span class="fm">__iter__</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
                    <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">result_format</span> <span class="o">==</span> <span class="s2">&quot;parquet&quot;</span><span class="p">:</span>
                    <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span>
                    <span class="n">tempfilename</span> <span class="o">=</span> <span class="n">tmpfile</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">cos_client</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">bucket_objects</span><span class="p">[</span><span class="n">pagenumber</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Filename</span><span class="o">=</span><span class="n">tempfilename</span><span class="p">)</span>
                    <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">tempfilename</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">result_format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">bucket_objects</span><span class="p">[</span><span class="n">pagenumber</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="s1">&#39;Body&#39;</span><span class="p">]</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid pagenumner (</span><span class="si">{}</span><span class="s2">) specified&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pagenumber</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Loop over result objects and read and concatenate them into result data frame</span>
            <span class="k">for</span> <span class="n">bucket_object</span> <span class="ow">in</span> <span class="n">bucket_objects</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">result_format</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">bucket_object</span><span class="p">)[</span><span class="s1">&#39;Body&#39;</span><span class="p">]</span>
                    <span class="c1"># add missing __iter__ method, so pandas accepts body as file-like object</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span> <span class="n">body</span><span class="o">.</span><span class="fm">__iter__</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

                    <span class="n">partition_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">error_bad_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">result_format</span> <span class="o">==</span> <span class="s2">&quot;parquet&quot;</span><span class="p">:</span>
                    <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span>
                    <span class="n">tempfilename</span> <span class="o">=</span> <span class="n">tmpfile</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">cos_client</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">bucket_object</span><span class="p">,</span> <span class="n">Filename</span><span class="o">=</span><span class="n">tempfilename</span><span class="p">)</span>

                    <span class="n">partition_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">tempfilename</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">result_format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">bucket_object</span><span class="p">)[</span><span class="s1">&#39;Body&#39;</span><span class="p">]</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

                    <span class="n">partition_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Add columns from hive style partition naming schema</span>
                <span class="n">hive_partition_candidates</span> <span class="o">=</span> <span class="n">bucket_object</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">hive_partition_candidate</span> <span class="ow">in</span> <span class="n">hive_partition_candidates</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">hive_partition_candidate</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Hive style folder names contain exactly one &#39;=&#39;</span>
                        <span class="n">column</span> <span class="o">=</span> <span class="n">hive_partition_candidate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
                        <span class="n">column_name</span> <span class="o">=</span> <span class="n">column</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">column_value</span> <span class="o">=</span> <span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">column_value</span> <span class="o">==</span> <span class="s1">&#39;__HIVE_DEFAULT_PARTITION__&#39;</span><span class="p">:</span> <span class="c1"># Null value partition</span>
                            <span class="n">column_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">partition_df</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_value</span>

                <span class="k">if</span> <span class="s1">&#39;result_df&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                    <span class="n">result_df</span> <span class="o">=</span> <span class="n">partition_df</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">partition_df</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;result_df&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">result_df</span></div>

<div class="viewcode-block" id="SQLQuery.list_results"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.list_results">[docs]</a>    <span class="k">def</span> <span class="nf">list_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobId</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        NOTE: A single SQL Query can store the queried data in the COS output</span>
<span class="sd">        in multiple objects/partitions</span>

<span class="sd">        When one of those below is used</span>

<span class="sd">        .. code-block:: console</span>

<span class="sd">            [ PARTITIONED BY,</span>
<span class="sd">            PARTITIONED EVERY x ROWS      [implicitly used with pagesize=X option]</span>
<span class="sd">            ]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ------------</span>
<span class="sd">        job_id: str</span>
<span class="sd">            The Job ID</span>
<span class="sd">        wait: bool, default:False</span>
<span class="sd">            If True, wait for the requested `job_id` to complete to get the information</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            None (or nothing) if the function fails</span>

<span class="sd">            DataFrame (4 fields: ObjectURL, Size, Bucket, Object) - each row correspond to the information of one partition</span>

<span class="sd">        Raises</span>
<span class="sd">        ----------</span>
<span class="sd">            ValueError</span>

<span class="sd">        Notes</span>
<span class="sd">        -------</span>
<span class="sd">            To know the number of partitions being used, use &#39;len(self.list_results(job_id))&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">list_results</span><span class="p">(</span><span class="n">jobId</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

            <span class="n">job_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">jobId</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;running&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SQL job with jobId </span><span class="si">{}</span><span class="s1"> still running. Come back later.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SQL job with jobId </span><span class="si">{}</span><span class="s1"> did not finish successfully. No result available.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;resultset_location&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_details</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">result_location</span> <span class="o">=</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;resultset_location&#39;</span><span class="p">]</span>
            <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">result_location</span><span class="p">)</span>
            <span class="n">result_bucket</span> <span class="o">=</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span>
            <span class="n">result_endpoint</span> <span class="o">=</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span>
            <span class="n">result_objects_df</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">list_cos_objects</span><span class="p">(</span><span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;resultset_location&#39;</span><span class="p">])</span>
            <span class="n">result_objects_df</span><span class="p">[</span><span class="s1">&#39;Bucket&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_bucket</span>
            <span class="n">result_objects_df</span><span class="p">[</span><span class="s1">&#39;ObjectURL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_objects_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;cos://</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result_endpoint</span><span class="p">,</span> <span class="n">result_bucket</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Object&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result_objects_df</span>

        <span class="n">job_id</span> <span class="o">=</span> <span class="n">jobId</span>
        <span class="k">if</span> <span class="n">wait</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">job_running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="n">job_running</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">list_results</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
                    <span class="n">job_running</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;running&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">list_results</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="SQLQuery.rename_exact_result"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.rename_exact_result">[docs]</a>    <span class="k">def</span> <span class="nf">rename_exact_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobId</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A SQL Query can store data into partitioned/paginated multiple objects, or single object.</span>

<span class="sd">        Even with single object, indeed, multiple objects are created, two of them has size 0.</span>
<span class="sd">        (&lt;URL&gt;/_SUCCESS, and &lt;URL&gt;/) beside the ones that hold data (&lt;URL&gt;/&lt;data1&gt;, &lt;URL&gt;/&lt;data2&gt;)</span>

<span class="sd">        This API deletes the two 0-size objects, and keep only the ones that hold data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_id : str</span>
<span class="sd">            A string representation of job_id</span>

<span class="sd">        wait: bool, optional</span>
<span class="sd">            The given `job_id` may not be completed yet, so you have the option to wait for it to completed first.</span>

<span class="sd">            Default is False</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        None</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the job_id is the job in that the result is &quot;PARTITIONED BY&quot; or &quot;pagesize=&quot; or &quot;PARITIONED EVERY x ROWS&quot; is used</span>
<span class="sd">            or the rename_exact_result() has been applied to this job_id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

        <span class="n">job_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">jobId</span><span class="p">)</span>
        <span class="n">job_status</span> <span class="o">=</span> <span class="n">job_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wait</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">job_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_job</span><span class="p">(</span><span class="n">jobId</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_status</span> <span class="o">==</span> <span class="s1">&#39;running&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SQL job with jobId </span><span class="si">{}</span><span class="s1"> still running. Come back later.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobId</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">job_status</span> <span class="o">!=</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SQL job with jobId </span><span class="si">{}</span><span class="s1"> did not finish successfully. No result available.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobId</span><span class="p">))</span>

        <span class="k">if</span> <span class="s2">&quot;resultset_location&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_details</span> <span class="ow">or</span> <span class="n">job_details</span><span class="p">[</span>
                <span class="s2">&quot;resultset_location&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;resultset_location&#39;</span><span class="p">])</span>
        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>

        <span class="n">result_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_results</span><span class="p">(</span><span class="n">jobId</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_objects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Renaming partitioned results of jobId </span><span class="si">{}</span><span class="s1"> to single exact result object name not supported.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobId</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result_objects</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>\
                <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_objects</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Results of job_id </span><span class="si">{}</span><span class="s1"> don</span><span class="se">\&#39;</span><span class="s1">t seem to be regular SQL query output.&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobId</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_objects</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># HANDLING  [can be 2 rows or 3 rows] - only the last row can be non-zero in size</span>
        <span class="n">max_row_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_objects</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">pre_row_zeros</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_row_index</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Size</span><span class="p">[</span><span class="n">row</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pre_row_zeros</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">pre_row_zeros</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Results of job_id </span><span class="si">{}</span><span class="s1"> don</span><span class="se">\&#39;</span><span class="s1">t seem to be regular SQL query output.&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobId</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_objects</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># basically copy the object[2] to object[0]</span>
            <span class="c1"># then delete object[2] and object[1]</span>
            <span class="n">copy_source</span> <span class="o">=</span> <span class="n">result_objects</span><span class="o">.</span><span class="n">Bucket</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">result_objects</span><span class="o">.</span><span class="n">Object</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">cos_client</span><span class="o">.</span><span class="n">copy_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Bucket</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">CopySource</span><span class="o">=</span><span class="n">copy_source</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Object</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cos_client</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Bucket</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Key</span><span class="o">=</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Object</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">cos_client</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Bucket</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Key</span><span class="o">=</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Object</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># len(result_objects) == 2</span>
            <span class="n">cos_client</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Bucket</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="n">Key</span><span class="o">=</span><span class="n">result_objects</span><span class="o">.</span><span class="n">Object</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="SQLQuery.rename_exact_result_joblist"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.rename_exact_result_joblist">[docs]</a>    <span class="k">def</span> <span class="nf">rename_exact_result_joblist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_list</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The bulk mode of `rename_exact_result` method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_list: list</span>
<span class="sd">            A list of job_id</span>
<span class="sd">        wait: bool, optional</span>
<span class="sd">            The same meaning as the one used in :meth:`.rename_exact_result`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">job_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename_exact_result</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLQuery.delete_result"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.delete_result">[docs]</a>    <span class="k">def</span> <span class="nf">delete_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns</span>
<span class="sd">        ------</span>
<span class="sd">        dataframe</span>
<span class="sd">            A dataframe, with 3 rows, and one field name &quot;Deleted Object&quot;</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Delete 3 entries in the output COS</span>

<span class="sd">        .. code-block:: console</span>

<span class="sd">            cos://&lt;cos-name&gt;/bucket_name/jobid=&lt;JOB-ID-NUMBER&gt;/</span>
<span class="sd">            cos://&lt;cos-name&gt;/bucket_name/jobid=&lt;JOB-ID-NUMBER&gt;/_SUCCESS</span>
<span class="sd">            cos://&lt;cos-name&gt;/bucket_name/jobid=&lt;JOB-ID-NUMBER&gt;/[parquet|csv|json]</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>

<span class="sd">        * The last entry holds the real data, and the last word also indicates the data format</span>
<span class="sd">        * &#39;JOBPREFIX NONE&#39;  would avoid having &#39;jobid=JOB-ID-NAME&#39; in the URL</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

        <span class="n">job_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">jobId</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;running&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SQL job with jobId </span><span class="si">{}</span><span class="s1"> still running. Come back later.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SQL job with jobId </span><span class="si">{}</span><span class="s1"> did not finish successfully. No result available.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;resultset_location&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_details</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">result_location</span> <span class="o">=</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;resultset_location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;cos&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="n">result_location</span><span class="p">)</span>
        <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span>
        <span class="n">bucket_objects_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_cos_objects</span><span class="p">(</span><span class="n">result_location</span><span class="p">)[[</span><span class="s1">&#39;Object&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">bucket_objects_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are no result objects for the jobid </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobId</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">bucket_objects_df</span> <span class="o">=</span> <span class="n">bucket_objects_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Object&quot;</span><span class="p">:</span> <span class="s2">&quot;Key&quot;</span><span class="p">})</span>
        <span class="n">bucket_objects</span> <span class="o">=</span> <span class="n">bucket_objects_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>

        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">delete_objects</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">Delete</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Objects&#39;</span><span class="p">:</span> <span class="n">bucket_objects</span><span class="p">})</span>

        <span class="n">deleted_list_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Deleted Object&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">deleted_object</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Deleted&#39;</span><span class="p">]:</span>
            <span class="n">deleted_list_df</span> <span class="o">=</span> <span class="n">deleted_list_df</span><span class="o">.</span><span class="n">append</span><span class="p">([{</span><span class="s1">&#39;Deleted Object&#39;</span><span class="p">:</span> <span class="n">deleted_object</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]}],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">deleted_list_df</span></div>

<div class="viewcode-block" id="SQLQuery.get_job"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.get_job">[docs]</a>    <span class="k">def</span> <span class="nf">get_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobId</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            a dict of job details (see keys below)</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            &#39;job_id&#39;,</span>
<span class="sd">            &#39;status&#39;, : &quot;running&quot;, &quot;failed&quot;, &quot;completed&quot;</span>
<span class="sd">            &#39;statement&#39;: &quot;SELECT * ...&quot; [the content of SQL Query],</span>
<span class="sd">            &#39;plan_id&#39; ,</span>
<span class="sd">            &#39;submit_time&#39;,</span>
<span class="sd">            &#39;resultset_location&#39;,</span>
<span class="sd">            &#39;rows_returned&#39;,</span>
<span class="sd">            &#39;rows_read&#39; ,</span>
<span class="sd">            &#39;bytes_read&#39; ,</span>
<span class="sd">            &#39;resultset_format&#39;: &#39;csv&#39;,</span>
<span class="sd">            &#39;end_time&#39;: &#39;2020-03-06T21:58:26.274Z&#39;,</span>
<span class="sd">            &#39;user_id&#39;: &#39;username@us.ibm.com&#39;</span>

<span class="sd">        Example</span>
<span class="sd">        --------</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {</span>
<span class="sd">                &quot;bytes_read&quot;: 43058,</span>
<span class="sd">                &quot;end_time&quot;: &quot;2020-03-08T03:20:39.131Z&quot;,</span>
<span class="sd">                &quot;job_id&quot;: &quot;ab3f7567-280b-40c9-87a9-256b846f89db&quot;,</span>
<span class="sd">                &quot;plan_id&quot;: &quot;ead0f7f5-0c96-40c0-9aae-63c4846d8188&quot;,</span>
<span class="sd">                &quot;resultset_format&quot;: &quot;parquet&quot;,</span>
<span class="sd">                &quot;resultset_location&quot;: &quot;cos://s3.us-south.cloud-object-storage.appdomain.cloud/tuan-sql-result/customer_orders/jobid=ab3f7567-280b-40c9-87a9-256b846f89db&quot;,</span>
<span class="sd">                &quot;rows_read&quot;: 921,</span>
<span class="sd">                &quot;rows_returned&quot;: 830,</span>
<span class="sd">                &quot;statement&quot;: &quot;SELECT OrderID, c.CustomerID CustomerID, CompanyName, ContactName, ContactTitle, Address, City, Region, PostalCode, Country, Phone, Fax          EmployeeID, OrderDate, RequiredDate, ShippedDate, ShipVia, Freight, ShipName, ShipAddress,          ShipCity, ShipRegion, ShipPostalCode, ShipCountry FROM cos://us-geo/sql/orders.parquet STORED AS PARQUET o,          cos://us-geo/sql/customers.parquet STORED AS PARQUET c          WHERE c.CustomerID = o.CustomerID          INTO cos://us-south/tuan-sql-result/customer_orders STORED AS PARQUET PARTITIONED BY (ShipCountry, ShipCity)&quot;,</span>
<span class="sd">                &quot;status&quot;: &quot;completed&quot;,</span>
<span class="sd">                &quot;submit_time&quot;: &quot;2020-03-08T03:20:00.617Z&quot;,</span>
<span class="sd">                &quot;user_id&quot;: &quot;tmhoangt@us.ibm.com&quot;</span>
<span class="sd">            }</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">get_job</span><span class="p">(</span><span class="n">jobId</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;https://api.sql-query.cloud.ibm.com/v2/sql_jobs/</span><span class="si">{}</span><span class="s2">?instance_crn=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_crn</span><span class="p">),</span>
                    <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SQL jobId </span><span class="si">{}</span><span class="s2"> unknown&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobId</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="n">job_id</span> <span class="o">=</span> <span class="n">jobId</span>
        <span class="k">if</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs_tracking</span> <span class="ow">and</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs_tracking</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs_tracking</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">get_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error at querying job </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_id</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs_tracking</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SQLQuery.get_jobs"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.get_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">get_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the up-to-30 most recent jobs from the given Cloud API</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataframe</span>
<span class="sd">            a pd.DataFrame with fields - total 30 rows, corresponding to the 30 most recent jobs</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        .. code-block:: console</span>

<span class="sd">            job_id</span>
<span class="sd">            status: &quot;running&quot;, &quot;failed&quot;, &quot;completed&quot;</span>
<span class="sd">            user_id</span>
<span class="sd">            statement</span>
<span class="sd">            resultset_location</span>
<span class="sd">            submit_time</span>
<span class="sd">            end_time</span>
<span class="sd">            rows_read</span>
<span class="sd">            rows_returned</span>
<span class="sd">            bytes_read</span>
<span class="sd">            error</span>
<span class="sd">            error_message</span>

<span class="sd">        .. code-block:: console</span>

<span class="sd">            job_id	status	user_id	statement	resultset_location	submit_time	end_time	rows_read	rows_returned	bytes_read	error	error_message</span>
<span class="sd">            8d9c5a97-808f-4a08-9cc3-78e3f07f7ba8	completed	tmhoangt@us.ibm.com	SELECT o.OrderID, c.CompanyName, e.FirstName, e.LastName FROM cos://us-geo/sql/orders.parquet STORED AS PARQUET o, cos://us-geo/sql/employees.parquet STORED AS PARQUET e, cos://us-geo/sql/customers.parquet STORED AS PARQUET c WHERE e.EmployeeID = o.EmployeeID AND c.CustomerID = o.CustomerID AND o.ShippedDate &gt; o.RequiredDate AND o.OrderDate &gt; &quot;1998-01-01&quot; ORDER BY c.CompanyName	cos://s3.us-south.cloud-object-storage.appdomain.cloud/tuan-sql-result/jobid=8d9c5a97-808f-4a08-9cc3-78e3f07f7ba8	2020-02-21T16:19:03.638Z	2020-02-21T16:19:13.691Z	1760	29	41499	None	None</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>

<span class="sd">        * get_jobs() is used by export_job_history(cos_out_url) which is used to save such data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;https://api.sql-query.cloud.ibm.com/v2/sql_jobs?instance_crn=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_crn</span><span class="p">),</span>
            <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
            <span class="n">job_list</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">job_list_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;statement&#39;</span><span class="p">,</span> <span class="s1">&#39;resultset_location&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;submit_time&#39;</span><span class="p">,</span> <span class="s1">&#39;end_time&#39;</span><span class="p">,</span> <span class="s1">&#39;rows_read&#39;</span><span class="p">,</span> <span class="s1">&#39;rows_returned&#39;</span><span class="p">,</span> <span class="s1">&#39;bytes_read&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;error_message&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">job_list</span><span class="p">[</span><span class="s1">&#39;jobs&#39;</span><span class="p">]:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;https://api.sql-query.cloud.ibm.com/v2/sql_jobs/</span><span class="si">{}</span><span class="s2">?instance_crn=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">],</span>
                                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">instance_crn</span><span class="p">),</span>
                    <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request_headers</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
                    <span class="n">job_details</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="c1"># None gets converted to integer type in pandas.to_parquet</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">rows_read</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">rows_returned</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">bytes_read</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">end_time</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">job_details</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;end_time&#39;</span> <span class="ow">in</span> <span class="n">job_details</span><span class="p">:</span>
                        <span class="n">end_time</span> <span class="o">=</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;error_message&#39;</span> <span class="ow">in</span> <span class="n">job_details</span><span class="p">:</span>
                        <span class="n">error_message</span> <span class="o">=</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;rows_read&#39;</span> <span class="ow">in</span> <span class="n">job_details</span><span class="p">:</span>
                        <span class="n">rows_read</span> <span class="o">=</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;rows_read&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;rows_returned&#39;</span> <span class="ow">in</span> <span class="n">job_details</span><span class="p">:</span>
                        <span class="n">rows_returned</span> <span class="o">=</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;rows_returned&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;bytes_read&#39;</span> <span class="ow">in</span> <span class="n">job_details</span><span class="p">:</span>
                        <span class="n">bytes_read</span> <span class="o">=</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;bytes_read&#39;</span><span class="p">]</span>
                    <span class="n">resultset_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                    <span class="k">if</span> <span class="s1">&#39;resultset_location&#39;</span> <span class="ow">in</span> <span class="n">job_details</span><span class="p">:</span>
                        <span class="n">resultset_loc</span> <span class="o">=</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;resultset_location&#39;</span><span class="p">]</span>
                    <span class="n">job_list_df</span> <span class="o">=</span> <span class="n">job_list_df</span><span class="o">.</span><span class="n">append</span><span class="p">([{</span><span class="s1">&#39;job_id&#39;</span><span class="p">:</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">],</span>
                                                       <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">],</span>
                                                       <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],</span>
                                                       <span class="s1">&#39;statement&#39;</span><span class="p">:</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;statement&#39;</span><span class="p">],</span>
                                                       <span class="s1">&#39;resultset_location&#39;</span><span class="p">:</span> <span class="n">resultset_loc</span><span class="p">,</span>
                                                       <span class="s1">&#39;submit_time&#39;</span><span class="p">:</span> <span class="n">job_details</span><span class="p">[</span><span class="s1">&#39;submit_time&#39;</span><span class="p">],</span>
                                                       <span class="s1">&#39;end_time&#39;</span><span class="p">:</span> <span class="n">end_time</span><span class="p">,</span>
                                                       <span class="s1">&#39;rows_read&#39;</span><span class="p">:</span> <span class="n">rows_read</span><span class="p">,</span>
                                                       <span class="s1">&#39;rows_returned&#39;</span><span class="p">:</span> <span class="n">rows_returned</span><span class="p">,</span>
                                                       <span class="s1">&#39;bytes_read&#39;</span><span class="p">:</span> <span class="n">bytes_read</span><span class="p">,</span>
                                                       <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span>
                                                       <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="n">error_message</span><span class="p">,</span>
                                                       <span class="p">}],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Job details retrieval for jobId </span><span class="si">{}</span><span class="s2"> failed with http code </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">],</span>
                                                                                               <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Job list retrieval failed with http code </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">job_list_df</span></div>

<div class="viewcode-block" id="SQLQuery.get_jobs_with_status"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.get_jobs_with_status">[docs]</a>    <span class="nd">@validate_job_status</span>
    <span class="k">def</span> <span class="nf">get_jobs_with_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id_list</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Among those given, return the list of job_id that have the given status</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        job_id_list: list</span>
<span class="sd">            List of job_id to check</span>
<span class="sd">        status : str</span>
<span class="sd">            &quot;completed&quot;, &quot;running&quot;, or &quot;failed&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        list:</span>
<span class="sd">            List of job ids</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="n">job_id_list</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="SQLQuery.get_jobs_count_with_status"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.get_jobs_count_with_status">[docs]</a>    <span class="nd">@validate_job_status</span>
    <span class="k">def</span> <span class="nf">get_jobs_count_with_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the number of jobs in the SQL Query server for the given `status`</span>

<span class="sd">        It has the limitation as described in :meth:`.get_jobs`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">()</span>
        <span class="n">num_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">[</span><span class="n">jobs</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">status</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">num_jobs</span></div>

<div class="viewcode-block" id="SQLQuery.get_number_running_jobs"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.get_number_running_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">get_number_running_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; return the number of running jobs in the SQL Query server&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jobs_count_with_status</span><span class="p">(</span><span class="s1">&#39;running&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLQuery.execute_sql"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.execute_sql">[docs]</a>    <span class="k">def</span> <span class="nf">execute_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql_stmt</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">get_result</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extend the behavior of :meth:`.run_sql`.</span>
<span class="sd">        I.e. it is a blocking call that waits for the job to finish (unlike :meth:`.submit_sql`), but it has the following features:</span>

<span class="sd">        1. Returning of data as Pandas dataframe is optional (get_result parameter) to help avoiding Python runtime memory overload.</span>
<span class="sd">            This is also useful when you run SQL statements such as DDLs that don&#39;t produce results at all.</span>
<span class="sd">        2. returns a namedtuple, in that result.data is the one returned by `run_sql`, while result.job_id is the extra part.</span>

<span class="sd">        Parameters</span>
<span class="sd">        --------------</span>
<span class="sd">        sql_stmt: str</span>
<span class="sd">            the SQL statement to run</span>

<span class="sd">        pagesize: int, optional</span>
<span class="sd">            an integer indicating the number of rows for each partition/page [using PARTITIONED EVERY &lt;pagesize&gt; ROWS syntax]</span>

<span class="sd">        get_result: bool, optional (default=False)</span>
<span class="sd">            When set it will return only the job_id, but still wait for the job&#39;s completion.</span>
<span class="sd">            Later, you can get the data using :meth:`.get_result` (job_id, pagenumber)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        namedtuple [`data`, `job_id`]</span>
<span class="sd">            `get_result` = True, then behavior like :meth:`.run_sql` which materializes the returned data as type</span>
<span class="sd">             pd.DataFrame in memory. The default behavior is opposite, to avoid unintended overload of memory.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Container</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;RunSql&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;job_id&#39;</span><span class="p">])</span>

        <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_sql</span><span class="p">(</span>
            <span class="n">sql_stmt</span><span class="p">,</span>
            <span class="n">pagesize</span><span class="o">=</span><span class="n">pagesize</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">job_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Job &quot;</span> <span class="o">+</span> <span class="n">job_id</span> <span class="o">+</span> <span class="s2">&quot; terminated with status: &quot;</span> <span class="o">+</span>
                     <span class="n">job_status</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_status</span> <span class="o">==</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get_result</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_result</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">job_status</span> <span class="o">==</span> <span class="s2">&quot;unknown&quot;</span><span class="p">:</span>
            <span class="n">job_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job_status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{status}</span><span class="s2">: SQL job </span><span class="si">{job_id}</span><span class="s2"> failed while executing with error </span><span class="si">{error}</span><span class="s2">. Detailed message: </span><span class="si">{msg}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">job_status</span><span class="p">,</span>
                    <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">],</span>
                    <span class="n">msg</span><span class="o">=</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="n">mycontainer</span> <span class="o">=</span> <span class="n">Container</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mycontainer</span></div>

<div class="viewcode-block" id="SQLQuery.run_sql"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.run_sql">[docs]</a>    <span class="k">def</span> <span class="nf">run_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql_text</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submits a SQL job, waits for the job to finish (unlike :meth:`.submit_sql`) and return the result as Pandas DataFrame.</span>

<span class="sd">        Parameters</span>
<span class="sd">        --------------</span>
<span class="sd">        sql_text: str</span>
<span class="sd">            the SQL statement to run</span>

<span class="sd">        pagesize: int, optional</span>
<span class="sd">            an integer indicating the number of rows for each partition/page [using PARTITIONED EVERY &lt;pagesize&gt; ROWS syntax]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            pd.DataFrame with the query results.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_sql</span><span class="p">(</span><span class="n">sql_text</span><span class="p">,</span> <span class="n">pagesize</span><span class="p">)</span>
        <span class="n">job_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
            <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;SQL job </span><span class="si">{job_id}</span><span class="s2"> failed while executing with error </span><span class="si">{error}</span><span class="s2">. Detailed message: </span><span class="si">{msg}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">],</span>
                    <span class="n">msg</span><span class="o">=</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">])</span>
                <span class="n">cos_in_url_error_msg</span> <span class="o">=</span> <span class="s2">&quot;Specify a valid Cloud Object Storage location&quot;</span>
                <span class="n">cos_out_url_error_msg</span> <span class="o">=</span> <span class="s2">&quot;Specify a valid Cloud Object Storage bucket location&quot;</span>
                <span class="k">if</span> <span class="n">cos_in_url_error_msg</span> <span class="ow">in</span> <span class="n">error_message</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CosUrlNotFoundException</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cos_out_url_error_msg</span> <span class="ow">in</span> <span class="n">error_message</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CosUrlNotFoundException</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_result</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLQuery.run"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pagesize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">get_result</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; run the internal SQL statement provided by SQLMagic using :meth:`.execute_sql`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql_stmt</span><span class="p">,</span>
            <span class="n">pagesize</span><span class="o">=</span><span class="n">pagesize</span><span class="p">,</span>
            <span class="n">get_result</span><span class="o">=</span><span class="n">get_result</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLQuery.process_failed_jobs_until_all_completed"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.process_failed_jobs_until_all_completed">[docs]</a>    <span class="k">def</span> <span class="nf">process_failed_jobs_until_all_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        re-send those that are failed - due to the time-out mechanism of SQL Query server</span>

<span class="sd">        Here, if job_time &lt; 40 minutes, then we re-send.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">complete_all</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="n">complete_all</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">complete_all</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job_id_list</span><span class="p">):</span>
                <span class="n">job_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                        <span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                            <span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;submit_time&quot;</span><span class="p">])</span>
                    <span class="n">job_time</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">job_time</span> <span class="o">&lt;</span> <span class="mi">2400</span><span class="p">:</span>  <span class="c1"># 40 minutes</span>
                        <span class="n">new_job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_sql</span><span class="p">(</span><span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;statement&quot;</span><span class="p">])</span>
                        <span class="n">job_id_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_job_id</span>
                        <span class="n">complete_all</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">job_id_list</span></div>

<div class="viewcode-block" id="SQLQuery.sql_ui_link"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.sql_ui_link">[docs]</a>    <span class="k">def</span> <span class="nf">sql_ui_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; both print out and also return the string containing SQL Query URL&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logon</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;https://sql-query.cloud.ibm.com/sqlquery/?instance_crn=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_crn</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;https://sql-query.cloud.ibm.com/sqlquery/?instance_crn=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance_crn</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SQLQuery.export_job_history"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.export_job_history">[docs]</a>    <span class="k">def</span> <span class="nf">export_job_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">export_file_prefix</span> <span class="o">=</span> <span class="s2">&quot;job_export_&quot;</span><span class="p">,</span> <span class="n">export_file_suffix</span> <span class="o">=</span> <span class="s2">&quot;.parquet&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export the most recent jobs to COS URL</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cos_url : str</span>
<span class="sd">            A COS URL with prefix, i.e. cos://&lt;cos-name&gt;/&lt;bucket&gt;/&lt;prefix&gt;,</span>
<span class="sd">            where the data will be stored</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cos_url</span><span class="p">:</span>
            <span class="c1"># Default export location is target COS URL set at __init__</span>
            <span class="c1"># But we&#39;ll overwrite that with the provided export URL</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_cos_url</span> <span class="o">=</span> <span class="n">cos_url</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_cos_url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No configured export COS URL.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_cos_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_cos_url</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span>
        <span class="n">url_parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_cos_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_cos_url</span><span class="p">)</span>

        <span class="n">job_history_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">()</span> <span class="c1"># Retrieve current job history (most recent 30 jobs)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">job_history_df</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_history_df</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">unicode</span><span class="p">)</span>
            <span class="n">job_history_df</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_history_df</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">unicode</span><span class="p">)</span>
        <span class="n">terminated_job_history_df</span> <span class="o">=</span> <span class="n">job_history_df</span><span class="p">[</span><span class="n">job_history_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">])]</span> <span class="c1"># Only export terminated jobs</span>
        <span class="n">newest_job_end_time</span> <span class="o">=</span> <span class="n">terminated_job_history_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">terminated_job_history_df</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span><span class="o">.</span><span class="n">end_time</span>

        <span class="c1"># List all existing objects in export location and identify latest exported job timestamp:</span>
        <span class="n">cos_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cos_client</span><span class="p">(</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">paginator</span> <span class="o">=</span> <span class="n">cos_client</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s2">&quot;list_objects&quot;</span><span class="p">)</span>
        <span class="n">page_iterator</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Prefix</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">newest_exported_job_end_time</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">expected_object_prefix</span> <span class="o">=</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">export_file_prefix</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">page_iterator</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;Contents&quot;</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">page</span><span class="p">[</span><span class="s1">&#39;Contents&#39;</span><span class="p">]:</span>
                    <span class="n">object_name</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;Key&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">object_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">expected_object_prefix</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="n">prefix_end_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_object_prefix</span><span class="p">)</span>
                    <span class="n">suffix_index</span> <span class="o">=</span> <span class="n">object_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">export_file_suffix</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">prefix_end_index</span> <span class="o">&lt;</span> <span class="n">suffix_index</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">job_end_time</span> <span class="o">=</span> <span class="n">object_name</span><span class="p">[</span><span class="n">prefix_end_index</span><span class="p">:</span><span class="n">suffix_index</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">job_end_time</span> <span class="o">&gt;</span> <span class="n">newest_exported_job_end_time</span><span class="p">:</span>
                        <span class="n">newest_exported_job_end_time</span> <span class="o">=</span> <span class="n">job_end_time</span>

        <span class="c1"># Export all new jobs if there are some:</span>
        <span class="k">if</span> <span class="n">newest_exported_job_end_time</span> <span class="o">&lt;</span> <span class="n">newest_job_end_time</span><span class="p">:</span>
            <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span>
            <span class="n">tempfilename</span> <span class="o">=</span> <span class="n">tmpfile</span><span class="o">.</span><span class="n">name</span>
            <span class="n">new_jobs_df</span> <span class="o">=</span> <span class="n">terminated_job_history_df</span><span class="p">[</span><span class="n">terminated_job_history_df</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">newest_exported_job_end_time</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">new_jobs_df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;pyarrow&quot;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">tempfilename</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;snappy&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_jobs_df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;pyarrow&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">tempfilename</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;snappy&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">export_object</span> <span class="o">=</span> <span class="n">url_parsed</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">export_file_prefix</span> <span class="o">+</span> <span class="n">newest_job_end_time</span> <span class="o">+</span> <span class="n">export_file_suffix</span>
            <span class="n">cos_client</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">url_parsed</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Filename</span><span class="o">=</span><span class="n">tempfilename</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">export_object</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exported </span><span class="si">{}</span><span class="s2"> new jobs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_jobs_df</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>
            <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No new jobs to export&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLQuery.get_schema_data"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.get_schema_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_schema_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cos_url</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the schema information</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cos_url : str</span>
<span class="sd">            The COS URL where data is stored</span>
<span class="sd">        type : str, optional</span>
<span class="sd">            The format type of the data, default is &#39;json&#39;</span>
<span class="sd">            Use from [&#39;json&#39;, &#39;csv&#39;, &#39;parquet&#39;] with case-insensitive</span>
<span class="sd">        dry_run: bool, optional</span>
<span class="sd">            This option, once selected as True, returns the internally generated SQL statement, and no job is queried.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataFrame</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;JSON&quot;</span><span class="p">,</span> <span class="s2">&quot;CSV&quot;</span><span class="p">,</span> <span class="s2">&quot;PARQUET&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;use wrong format&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Use wrong format of data: &#39;type&#39; option&quot;</span><span class="p">)</span>
        <span class="n">sql_stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT * FROM DESCRIBE(</span><span class="si">{cos_in}</span><span class="s2"> STORED AS </span><span class="si">{type}</span><span class="s2">)</span>
<span class="s2">        INTO </span><span class="si">{cos_out}</span><span class="s2"> STORED AS JSON</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_in</span><span class="o">=</span><span class="n">cos_url</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">cos_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span></div>

<div class="viewcode-block" id="SQLQuery.analyze"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.analyze">[docs]</a>    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provides some insights about the data layout from the current SQL statement</span>

<span class="sd">        Parameters</span>
<span class="sd">        -------------</span>
<span class="sd">        job_id : str</span>
<span class="sd">            The job ID</span>

<span class="sd">        todo</span>
<span class="sd">        ------</span>

<span class="sd">        1. new sql only when max_obj_size &gt; 300MB</span>
<span class="sd">        2. check if STORED AS is used, if not suggested adding to sql with PARQUET or JSON</span>
<span class="sd">        3. add PARITIONED ... not at the end, but right after STORED AS (which can be missing in original SQL)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">BestPracticeContainer</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;SqlBestPractice&#39;</span><span class="p">,</span>
                                           <span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;max_objs&#39;</span><span class="p">])</span>
        <span class="n">best_practice</span> <span class="o">=</span> <span class="n">BestPracticeContainer</span><span class="p">(</span><span class="s2">&quot;128 MB&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;completed&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Job </span><span class="si">{job_id}</span><span class="s2"> is </span><span class="si">{status}</span><span class="s2"> - no more insights&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">msg</span>

        <span class="n">cos_url</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;resultset_location&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cos_url</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Job </span><span class="si">{job_id}</span><span class="s2"> does not return anything - no more insights&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>

        <span class="n">cos_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cos_summary</span><span class="p">(</span><span class="n">cos_url</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_total_objects</span><span class="p">():</span>
            <span class="c1"># total_objects = cos_result[&#39;total_objects&#39;]  #not exact</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_results</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="n">seriesObj</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Size&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">total_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seriesObj</span><span class="p">[</span><span class="n">seriesObj</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">total_objects</span>

        <span class="n">total_objects</span> <span class="o">=</span> <span class="n">get_total_objects</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">get_size_in_MB</span><span class="p">(</span><span class="n">size_info</span><span class="p">):</span>
            <span class="n">num</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">size_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;TB&quot;</span><span class="p">:</span> <span class="mi">1048576</span><span class="p">,</span> <span class="s2">&quot;GB&quot;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span> <span class="s2">&quot;MB&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

            <span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
                <span class="n">size_MB</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">*</span> <span class="n">mapping</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">size_MB</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">return</span> <span class="n">size_MB</span>

        <span class="n">largest_size_MB</span> <span class="o">=</span> <span class="n">get_size_in_MB</span><span class="p">(</span><span class="n">cos_result</span><span class="p">[</span><span class="s1">&#39;largest_object_size&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">largest_size_MB</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">best_practice</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Job </span><span class="si">{job_id}</span><span class="s2"> looks fine - no more insights&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>

        <span class="n">total_volume_MB</span> <span class="o">=</span> <span class="n">get_size_in_MB</span><span class="p">(</span><span class="n">cos_result</span><span class="p">[</span><span class="s1">&#39;total_volume&#39;</span><span class="p">])</span>
        <span class="n">SqlContainer</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;SqlStatus&#39;</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="s1">&#39;total_data_objects&#39;</span><span class="p">,</span> <span class="s1">&#39;total_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;max_object_size&#39;</span>
        <span class="p">])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">SqlContainer</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">total_objects</span><span class="p">,</span> <span class="n">total_volume_MB</span><span class="p">,</span>
                             <span class="n">largest_size_MB</span><span class="p">)</span>
        <span class="n">mappings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span>
            <span class="s2">&quot;total_objects&quot;</span><span class="p">:</span> <span class="n">total_objects</span><span class="p">,</span>
            <span class="s2">&quot;total_volume_MB&quot;</span><span class="p">:</span> <span class="n">total_volume_MB</span>
        <span class="p">}</span>
        <span class="n">msg_01</span> <span class="o">=</span> <span class="s2">&quot;Job </span><span class="si">{job_id}</span><span class="s2"> has </span><span class="si">{total_objects}</span><span class="s2"> object</span><span class="si">{s}</span><span class="s2">, with </span><span class="si">{total_volume_MB}</span><span class="s2"> MB in total.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="o">**</span><span class="n">mappings</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">mappings</span><span class="p">[</span><span class="s2">&quot;total_objects&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mappings</span><span class="p">[</span><span class="s2">&quot;total_objects&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">msg_01</span> <span class="o">=</span> <span class="n">msg_01</span> <span class="o">+</span> <span class="s2">&quot; Current object size is ~ </span><span class="si">{size}</span><span class="s2"> MB&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">size</span><span class="o">=</span><span class="n">mappings</span><span class="p">[</span><span class="s2">&quot;total_volume_MB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">mappings</span><span class="p">[</span><span class="s2">&quot;total_objects&quot;</span><span class="p">])</span>

        <span class="n">mappings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">best_practice</span><span class="o">.</span><span class="n">size</span><span class="p">}</span>
        <span class="n">msg_02</span> <span class="o">=</span> <span class="s2">&quot;Best practices: object sizes ~ </span><span class="si">{size}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mappings</span><span class="p">)</span>

        <span class="n">mappings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;num_objs&quot;</span><span class="p">:</span>
            <span class="nb">min</span><span class="p">(</span><span class="n">best_practice</span><span class="o">.</span><span class="n">max_objs</span><span class="p">,</span>
                <span class="n">query</span><span class="o">.</span><span class="n">total_volume</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">best_practice</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="p">}</span>

        <span class="n">msg_03</span> <span class="o">=</span> <span class="s2">&quot;Current SQL:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{sql}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;statement&quot;</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">revise_storage</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="s2">&quot;parquet&quot;</span><span class="p">):</span>
            <span class="n">url_storage</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;INTO (cos)://[^\s]* STORED AS&#39;</span><span class="p">,</span> <span class="n">sql_stmt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">url_storage</span><span class="p">:</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">url_storage</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pre</span> <span class="o">=</span> <span class="n">sql_stmt</span><span class="p">[:</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">post</span> <span class="o">=</span> <span class="n">sql_stmt</span><span class="p">[</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
                <span class="n">detected_storage</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[^\s]*&#39;</span><span class="p">,</span> <span class="n">post</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">storage</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">detected_storage</span><span class="p">:</span>
                    <span class="n">post</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">detected_storage</span><span class="p">,</span> <span class="n">storage</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">pre</span> <span class="o">+</span> <span class="n">post</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;INTO (cos)://[^\s]*&#39;</span><span class="p">,</span> <span class="n">sql_stmt</span><span class="p">)</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span><span class="p">[:</span><span class="n">loc</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; STORED AS  &#39;</span> <span class="o">+</span> <span class="n">storage</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span>
                <span class="p">)</span> <span class="o">+</span> <span class="n">sql_stmt</span><span class="p">[</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="k">return</span> <span class="n">sql_stmt</span>

        <span class="k">def</span> <span class="nf">msg_partition_into</span><span class="p">():</span>
            <span class="n">msg_sub</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">msg_sub</span><span class="p">[</span>
                <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Consider using: PARTITIONED INTO </span><span class="si">{num_objs}</span><span class="s2"> OBJECTS/BUCKETS&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="o">**</span><span class="n">mappings</span><span class="p">)</span>

            <span class="n">new_sql</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;statement&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;PARTITION&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_sql</span><span class="p">:</span>
                <span class="n">new_sql</span> <span class="o">=</span> <span class="n">format_sql</span><span class="p">(</span><span class="n">revise_storage</span><span class="p">(</span><span class="n">new_sql</span><span class="p">,</span> <span class="s2">&quot;parquet&quot;</span><span class="p">))</span>
                <span class="kn">import</span> <span class="nn">re</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s1">&#39;INTO (cos)://[^\s]*[\s]+STORED[\s]+AS[\s]+PARQUET&#39;</span><span class="p">,</span>
                    <span class="n">new_sql</span><span class="p">)</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_sql</span> <span class="o">=</span> <span class="n">new_sql</span><span class="p">[:</span>
                                  <span class="n">loc</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; PARTITIONED INTO </span><span class="si">{num_objs}</span><span class="s2"> OBJECTS&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                      <span class="o">**</span><span class="n">mappings</span><span class="p">)</span> <span class="o">+</span> <span class="n">new_sql</span><span class="p">[</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;rows_returned&quot;</span><span class="p">]</span>
            <span class="n">msg_sub</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Suggested SQL:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{sql}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">new_sql</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg_sub</span>

        <span class="k">def</span> <span class="nf">msg_partition_every</span><span class="p">():</span>
            <span class="n">msg_05</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rows_returned&quot;</span><span class="p">])</span> <span class="o">/</span>
                <span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">total_volume</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">best_practice</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">msg_05</span><span class="p">[</span>
                <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Consider using: PARTITIONED EVERY </span><span class="si">{num_rows}</span><span class="s2"> ROWS&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="o">**</span><span class="n">mappings</span><span class="p">,</span> <span class="n">num_rows</span><span class="o">=</span><span class="n">num_rows</span><span class="p">)</span>

            <span class="n">new_sql</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;statement&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;PARITION&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_sql</span><span class="p">:</span>
                <span class="c1"># new_sql = new_sql + &quot; PARTITIONED EVERY {num_rows} ROWS&quot;.format(</span>
                <span class="c1">#    **mappings, num_rows=num_rows)</span>
                <span class="n">new_sql</span> <span class="o">=</span> <span class="n">format_sql</span><span class="p">(</span><span class="n">revise_storage</span><span class="p">(</span><span class="n">new_sql</span><span class="p">,</span> <span class="s2">&quot;parquet&quot;</span><span class="p">))</span>
                <span class="kn">import</span> <span class="nn">re</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s1">&#39;INTO (cos)://[^\s]*[\s]+STORED[\s]+AS[\s]+PARQUET&#39;</span><span class="p">,</span>
                    <span class="n">new_sql</span><span class="p">)</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">new_sql</span> <span class="o">=</span> <span class="n">new_sql</span><span class="p">[:</span>
                                  <span class="n">loc</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; PARTITIONED EVERY </span><span class="si">{num_rows}</span><span class="s2"> ROWS&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                      <span class="o">**</span><span class="n">mappings</span><span class="p">)</span> <span class="o">+</span> <span class="n">new_sql</span><span class="p">[</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;rows_returned&quot;</span><span class="p">]</span>
            <span class="n">msg_05</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Suggested SQL:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{sql}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">new_sql</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg_05</span>

        <span class="n">msg_04</span> <span class="o">=</span> <span class="n">msg_partition_into</span><span class="p">()</span>
        <span class="n">msg_05</span> <span class="o">=</span> <span class="n">msg_partition_every</span><span class="p">()</span>
        <span class="n">my_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">msg_01</span><span class="p">,</span> <span class="n">msg_02</span><span class="p">,</span> <span class="n">msg_03</span><span class="p">]</span>
        <span class="n">my_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">msg_04</span><span class="p">)</span>
        <span class="n">my_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">msg_05</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">my_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">msg</span></div>

    <span class="k">def</span> <span class="nf">_get_ts_datasource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span>
                <span class="n">cos_out</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="n">where_clause</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ops</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">num_objects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the data source for time-series in the next-query</span>

<span class="sd">        It will returns the data source in 3 columns: field_name, time_stamp, observation</span>

<span class="sd">        Parameters</span>
<span class="sd">        --------------</span>
<span class="sd">        table: str</span>
<span class="sd">            The catalog table name or the view-table that you generate from the WITH clause via :meth:`with_` method</span>
<span class="sd">        key: str</span>
<span class="sd">            The column name being used as the key, and is maped to `field_name`</span>
<span class="sd">        time_stamp: str</span>
<span class="sd">            The column name being used as timetick, and is mapped to `time_stamp`</span>
<span class="sd">        observation: str</span>
<span class="sd">            The column name being used as value, and is maped to `observation`</span>
<span class="sd">        cos_out: str</span>
<span class="sd">            The COS URL where the data is copied to - later as data source</span>
<span class="sd">        granularity: str</span>
<span class="sd">            There are 2 options:</span>

<span class="sd">            * a value in one of [&quot;raw&quot;, &quot;per_min&quot;, &quot;per_&lt;x&gt;min&quot;, &quot;per_sec&quot;, &quot;per_&lt;x&gt;sec&quot;, &quot;per_hour&quot;, &quot;per_&lt;x&gt;hour&quot;]</span>
<span class="sd">            with &lt;x&gt; is a number divided by 60, e.g. 10, 15</span>

<span class="sd">            * a value that follows ISO 8601 &#39;duration&#39;, e.g. PT1M, PT1S, PT2H</span>
<span class="sd">        ops: str</span>
<span class="sd">            The aggregation method: &quot;avg&quot;, &quot;sum&quot;, &quot;max&quot;, &quot;min&quot;, &quot;count&quot;</span>
<span class="sd">        dry_run: bool, optional</span>
<span class="sd">            This option, once selected as True, returns the internally generated SQL statement, and no job is queried.</span>
<span class="sd">        num_objects: None or int</span>
<span class="sd">            The number of objects to be created for storing the data. Using `num_objects` and `num_rows` are exclusive.</span>
<span class="sd">        num_rows: None or int</span>
<span class="sd">            The number of rows for each object to be created for storing the data. Using `num_objects` and `num_rows` are exclusive.</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        str</span>
<span class="sd">            The COS_URL where the data with 3 fields (key, time_stamp, observation)</span>
<span class="sd">            and can be digested into time-series via TIME_SERIES_FORMAT(key, timestick, value)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmp_cos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_cos_url</span>
        <span class="k">if</span> <span class="n">num_objects</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_rows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;provide at least `num_objects` or `num_rows`&quot;</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">granularity</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">granularity</span> <span class="o">==</span> <span class="s2">&quot;per_min&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">time_stamp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unixtime_columns</span><span class="p">:</span>
            <span class="c1">#  -- convert unix-time in ms to sec</span>
            <span class="n">time_info</span> <span class="o">=</span> <span class="s2">&quot;cast(</span><span class="si">{time_stamp}</span><span class="s2">/1000 as timestamp)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_stamp</span><span class="o">=</span><span class="n">time_stamp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time_info</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{time_stamp}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_stamp</span><span class="o">=</span><span class="n">time_stamp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">granularity</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
            <span class="n">tmp_cos</span> <span class="o">=</span> <span class="n">cos_out</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">where_clause</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">extra_where</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extra_where</span> <span class="o">=</span> <span class="s2">&quot;AND &quot;</span> <span class="o">+</span> <span class="n">where_clause</span>

        <span class="k">if</span> <span class="n">num_objects</span><span class="p">:</span>
            <span class="n">partition_clause</span> <span class="o">=</span> <span class="s2">&quot;PARTITIONED INTO </span><span class="si">{x}</span><span class="s2"> OBJECTS&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">num_objects</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_rows</span><span class="p">:</span>
            <span class="n">partition_clause</span> <span class="o">=</span> <span class="s2">&quot;PARTITIONED EVERY </span><span class="si">{x}</span><span class="s2"> ROWS&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">num_rows</span><span class="p">)</span>
        <span class="n">select_stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT </span><span class="si">{key}</span><span class="s2"> as field_name,</span>
<span class="s2">                </span><span class="si">{time_info}</span><span class="s2"> as time_stamp,</span>
<span class="s2">                </span><span class="si">{observation}</span><span class="s2"> as observation</span>
<span class="s2">            FROM </span><span class="si">{table_name}</span><span class="s2"></span>
<span class="s2">            WHERE isnotnull(</span><span class="si">{key}</span><span class="s2">) AND isnotnull(</span><span class="si">{observation}</span><span class="s2">)</span>
<span class="s2">            </span><span class="si">{extra_where}</span><span class="s2"></span>
<span class="s2">            INTO </span><span class="si">{cos_out}</span><span class="s2"> STORED AS PARQUET </span><span class="si">{partition_clause}</span><span class="s2"></span>
<span class="s2">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">cos_out</span><span class="o">=</span><span class="n">tmp_cos</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">observation</span><span class="o">=</span><span class="n">observation</span><span class="p">,</span> <span class="n">time_info</span><span class="o">=</span><span class="n">time_info</span><span class="p">,</span> <span class="n">extra_where</span><span class="o">=</span><span class="n">extra_where</span><span class="p">,</span>
                <span class="n">partition_clause</span><span class="o">=</span><span class="n">partition_clause</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_with_clause</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_select_clause</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sql_stmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_stmt</span> <span class="o">+</span> <span class="n">select_stmt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sql_stmt</span> <span class="o">=</span> <span class="n">select_stmt</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">print_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql_stmt</span><span class="p">)</span>
            <span class="n">select_container_id_full_location</span> <span class="o">=</span> <span class="s2">&quot;cos://dry_run/&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql_stmt</span><span class="p">)</span>
            <span class="n">select_container_id_full_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">job_id</span><span class="p">)[</span><span class="s1">&#39;resultset_location&#39;</span><span class="p">]</span>

        <span class="n">cos_in</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">granularity</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cos_in</span> <span class="o">=</span> <span class="n">select_container_id_full_location</span>

        <span class="k">def</span> <span class="nf">query_min</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            return:</span>
<span class="sd">                None or &#39;result&#39;</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">nonlocal</span> <span class="n">cos_in</span>
            <span class="kn">import</span> <span class="nn">re</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;per_[0-9]*min&#39;</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;per_[0-9]+min&#39;</span><span class="p">)</span>
            <span class="n">level</span> <span class="o">=</span> <span class="s2">&quot;raw&quot;</span>
            <span class="n">num_min</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">granularity</span><span class="p">):</span>
                <span class="n">level</span> <span class="o">=</span> <span class="s2">&quot;minute&quot;</span>
                <span class="k">if</span> <span class="n">p2</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">granularity</span><span class="p">):</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">granularity</span><span class="p">)</span>
                    <span class="n">num_min</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">temp</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">assert</span><span class="p">(</span><span class="mi">60</span> <span class="o">%</span> <span class="n">num_min</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">granularity</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;PT&#39;</span> <span class="ow">and</span> <span class="n">granularity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="s2">&quot;minute&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">isodate</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">isodate</span><span class="o">.</span><span class="n">parse_duration</span><span class="p">(</span><span class="n">granularity</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="n">num_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># (minute)</span>
                        <span class="k">assert</span><span class="p">(</span><span class="mi">60</span> <span class="o">%</span> <span class="n">num_min</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">ISO8601Error</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> unsupported&quot;</span> <span class="o">%</span> <span class="n">granularity</span><span class="p">)</span>
                        <span class="k">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="s2">&quot;minute&quot;</span><span class="p">:</span>
                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                select</span>
<span class="s2">                    field_name,</span>
<span class="s2">                    to_date(time_stamp) as time_stamp_date,</span>
<span class="s2">                    hour(time_stamp) as time_stamp_hour,</span>
<span class="s2">                    (floor(minute(time_stamp)/</span><span class="si">{num_min}</span><span class="s2">)) * </span><span class="si">{num_min}</span><span class="s2"> as time_stamp_minute, -- within [current, current+</span><span class="si">{num_min}</span><span class="s2">) minute time-window</span>
<span class="s2">                    </span><span class="si">{ops}</span><span class="s2">(observation) as </span><span class="si">{observation}</span><span class="s2"></span>
<span class="s2">                from </span><span class="si">{cos_in}</span><span class="s2"> stored as parquet</span>
<span class="s2">                group by field_name,  to_date(time_stamp), hour(time_stamp), (floor(minute(time_stamp)/</span><span class="si">{num_min}</span><span class="s2">)) * </span><span class="si">{num_min}</span><span class="s2"></span>
<span class="s2">                INTO </span><span class="si">{cos_out}</span><span class="s2"> STORED AS PARQUET </span><span class="si">{partition_clause}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_in</span><span class="o">=</span><span class="n">cos_in</span><span class="p">,</span> <span class="n">cos_out</span><span class="o">=</span><span class="n">tmp_cos</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">observation</span><span class="o">=</span><span class="n">observation</span><span class="p">,</span> <span class="n">time_info</span><span class="o">=</span><span class="n">time_info</span><span class="p">,</span> <span class="n">num_min</span><span class="o">=</span><span class="n">num_min</span><span class="p">,</span>
                    <span class="n">partition_clause</span><span class="o">=</span><span class="n">partition_clause</span><span class="p">,</span> <span class="n">ops</span><span class="o">=</span><span class="n">ops</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="n">print_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>

                <span class="c1"># Restore timestamp as single column</span>
                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="n">cos_in</span> <span class="o">=</span> <span class="s2">&quot;cos://dry_run/&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cos_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">job_id</span><span class="p">)[</span><span class="s1">&#39;resultset_location&#39;</span><span class="p">]</span>
                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                select</span>
<span class="s2">                    field_name, -- as </span><span class="si">{key}</span><span class="s2">,</span>
<span class="s2">                    to_timestamp(concat(date(time_stamp_date), &quot; &quot;, time_stamp_hour, &quot;:&quot;, time_stamp_minute), &quot;yyyy-MM-dd HH:mm&quot;) as time_stamp,</span>
<span class="s2">                    </span><span class="si">{observation}</span><span class="s2"> as observation</span>
<span class="s2">                from </span><span class="si">{cos_in}</span><span class="s2"> stored as parquet</span>
<span class="s2">                INTO </span><span class="si">{cos_out}</span><span class="s2"> STORED AS PARQUET </span><span class="si">{partition_clause}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_in</span><span class="o">=</span><span class="n">cos_in</span><span class="p">,</span> <span class="n">cos_out</span><span class="o">=</span><span class="n">cos_out</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">observation</span><span class="o">=</span><span class="n">observation</span><span class="p">,</span> <span class="n">time_info</span><span class="o">=</span><span class="n">time_info</span><span class="p">,</span>
                    <span class="n">partition_clause</span><span class="o">=</span><span class="n">partition_clause</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="n">print_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">def</span> <span class="nf">query_sec</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            return:</span>
<span class="sd">                None or &#39;result&#39;</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="kn">import</span> <span class="nn">re</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;per_[0-9]*sec&#39;</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;per_[0-9]+sec&#39;</span><span class="p">)</span>
            <span class="n">level</span> <span class="o">=</span> <span class="s2">&quot;raw&quot;</span>
            <span class="n">num_sec</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">granularity</span><span class="p">):</span>
                <span class="n">level</span> <span class="o">=</span> <span class="s2">&quot;sec&quot;</span>
                <span class="k">if</span> <span class="n">p2</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">granularity</span><span class="p">):</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">granularity</span><span class="p">)</span>
                    <span class="n">num_sec</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">temp</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">assert</span><span class="p">(</span><span class="mi">60</span> <span class="o">%</span> <span class="n">num_sec</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">granularity</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;PT&#39;</span> <span class="ow">and</span> <span class="n">granularity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="s2">&quot;sec&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">isodate</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">isodate</span><span class="o">.</span><span class="n">parse_duration</span><span class="p">(</span><span class="n">granularity</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="n">num_sec</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
                        <span class="k">assert</span><span class="p">(</span><span class="mi">60</span> <span class="o">%</span> <span class="n">num_sec</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">ISO8601Error</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> unsupported&quot;</span> <span class="o">%</span> <span class="n">granularity</span><span class="p">)</span>
                        <span class="k">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="s2">&quot;sec&quot;</span><span class="p">:</span>
                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                select</span>
<span class="s2">                    field_name,</span>
<span class="s2">                    to_date(time_stamp) as time_stamp_date,</span>
<span class="s2">                    hour(time_stamp) as time_stamp_hour,</span>
<span class="s2">                    minute(time_stamp) as time_stamp_minute,</span>
<span class="s2">                    (floor(second(time_stamp)/</span><span class="si">{num_sec}</span><span class="s2">)) * </span><span class="si">{num_sec}</span><span class="s2"> as time_stamp_second, -- within [current, current+</span><span class="si">{num_sec}</span><span class="s2">) second time-window</span>
<span class="s2">                    </span><span class="si">{ops}</span><span class="s2">(observation) as </span><span class="si">{observation}</span><span class="s2"></span>
<span class="s2">                from </span><span class="si">{cos_in}</span><span class="s2"> stored as parquet</span>
<span class="s2">                group by field_name,  to_date(time_stamp), hour(time_stamp), minute(time_stamp), (floor(second(time_stamp)/</span><span class="si">{num_sec}</span><span class="s2">)) * </span><span class="si">{num_sec}</span><span class="s2"></span>
<span class="s2">                INTO </span><span class="si">{cos_out}</span><span class="s2"> STORED AS PARQUET </span><span class="si">{partition_clause}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_in</span><span class="o">=</span><span class="n">cos_in</span><span class="p">,</span> <span class="n">cos_out</span><span class="o">=</span><span class="n">tmp_cos</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">observation</span><span class="o">=</span><span class="n">observation</span><span class="p">,</span> <span class="n">time_info</span><span class="o">=</span><span class="n">time_info</span><span class="p">,</span> <span class="n">num_sec</span><span class="o">=</span><span class="n">num_sec</span><span class="p">,</span>
                    <span class="n">partition_clause</span><span class="o">=</span><span class="n">partition_clause</span><span class="p">,</span> <span class="n">ops</span><span class="o">=</span><span class="n">ops</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="n">print_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>

                <span class="c1"># Restore timestamp as single column</span>
                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="n">init_cos</span> <span class="o">=</span> <span class="s2">&quot;cos://dry_run/&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">init_cos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">job_id</span><span class="p">)[</span><span class="s1">&#39;resultset_location&#39;</span><span class="p">]</span>
                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                select</span>
<span class="s2">                    field_name, -- as </span><span class="si">{key}</span><span class="s2">,</span>
<span class="s2">                    to_timestamp(concat(date(time_stamp_date), &quot; &quot;, &quot;:&quot;.join([time_stamp_hour, time_stamp_minute, time_stamp_second]), &quot;yyyy-MM-dd HH:mm:ss&quot;) as time_stamp,</span>
<span class="s2">                    </span><span class="si">{observation}</span><span class="s2"> as observation</span>
<span class="s2">                from </span><span class="si">{cos_in}</span><span class="s2"> stored as parquet</span>
<span class="s2">                INTO </span><span class="si">{cos_out}</span><span class="s2"> STORED AS PARQUET </span><span class="si">{partition_clause}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cos_in</span><span class="o">=</span><span class="n">cos_in</span><span class="p">,</span> <span class="n">cos_out</span><span class="o">=</span><span class="n">cos_out</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">observation</span><span class="o">=</span><span class="n">observation</span><span class="p">,</span> <span class="n">time_info</span><span class="o">=</span><span class="n">time_info</span><span class="p">,</span>
                    <span class="n">partition_clause</span><span class="o">=</span><span class="n">partition_clause</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="n">print_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">query_min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">query_sec</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="SQLQuery.get_ts_datasource"><a class="viewcode-back" href="../../ibmcloudsql.html#ibmcloudsql.SQLQuery.SQLQuery.get_ts_datasource">[docs]</a>    <span class="k">def</span> <span class="nf">get_ts_datasource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span>
                <span class="n">cos_out</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="n">where_clause</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ops</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">num_objects</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">print_warning</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the data source for time-series in the next-query, in that the result is</span>
<span class="sd">        broken down into multiple objects using `num_objects` as the criteria</span>

<span class="sd">        It will returns the data source in 3 columns:</span>
<span class="sd">        &lt;key&gt;, time_stamp, observation</span>

<span class="sd">        Parameters</span>
<span class="sd">        --------------</span>
<span class="sd">        table: str</span>
<span class="sd">            The catalog table name</span>
<span class="sd">        key: str</span>
<span class="sd">            The column name being used as the key</span>
<span class="sd">        time_stamp: str</span>
<span class="sd">            The column name being used as timestick</span>
<span class="sd">        observation: str</span>
<span class="sd">            The column name being used as value</span>
<span class="sd">        cos_out: str</span>
<span class="sd">            The COS URL where the data is copied to - later as data source</span>
<span class="sd">        granularity: str</span>
<span class="sd">            a value in one of [&quot;raw&quot;, &quot;per_min&quot;, &quot;per_&lt;x&gt;min&quot;, &quot;per_sec&quot;, &quot;per_&lt;x&gt;sec&quot;]</span>
<span class="sd">            with &lt;x&gt; is a number divided by 60, e.g. 10, 15</span>
<span class="sd">        dry_run: bool, optional</span>
<span class="sd">            This option, once selected as True, returns the internally generated SQL statement, and no job is queried.</span>
<span class="sd">        num_objects: int, optional</span>
<span class="sd">            The number of objects to be created for storing the data</span>
<span class="sd">        print_warning: bool, default=True</span>
<span class="sd">            print a warning or not</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        str</span>
<span class="sd">            The COS_URL where the data with 3 fields (key, time_stamp, observation)</span>
<span class="sd">            and can be digested into time-series via TIME_SERIES_FORMAT(key, timestick, value)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unixtime_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">print_warning</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: You may want to assign the list of columns to`.columns_in_unixtime` to let the SQL client know what columns are timestamp and in UNIX time format&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ts_datasource</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span>
                <span class="n">cos_out</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">num_objects</span><span class="o">=</span><span class="n">num_objects</span><span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2020, IBM Research.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>